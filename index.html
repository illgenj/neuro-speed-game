<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Neuro-Speed Elite 4.0</title>
    <style>
        :root { 
            --bg: #020617; --panel: #0f172a; --accent: #0ea5e9; --text: #f8fafc; 
            --success: #10b981; --fail: #ef4444; --gold: #f59e0b; --quantum: #a855f7; 
            --hyper: #f43f5e; --glass: rgba(15, 23, 42, 0.96);
        }
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; user-select: none; }
        
        body { 
            background: var(--bg); color: var(--text); 
            font-family: 'Inter', system-ui, -apple-system, sans-serif; 
            margin: 0; display: flex; flex-direction: column; 
            height: 100vh; overflow: hidden; touch-action: none; 
        }

        /* --- Header & Interactive Stats --- */
        .header { 
            height: 90px; width: 100%; display: flex; align-items: center; 
            background: var(--panel); border-bottom: 2px solid #1e293b; 
            z-index: 50; flex-shrink: 0;
        }
        .stat-group { display: flex; flex-grow: 1; justify-content: space-around; height: 100%; }
        
        .stat { 
            text-align: center; display: flex; flex-direction: column; 
            justify-content: center; padding: 0 5px; cursor: pointer; 
            transition: all 0.2s; min-width: 60px;
        }
        
        .label { font-size: 0.5rem; text-transform: uppercase; opacity: 0.4; letter-spacing: 1.2px; margin-bottom: 2px; font-weight: 700; }
        .val { font-size: 0.85rem; font-weight: 800; color: var(--accent); font-family: monospace; }
        .xp-val { color: var(--gold); transition: color 0.3s; }

        /* --- ZONE THERMOMETER --- */
        #zone-container {
            width: 90%; height: 24px; background: #0f172a; 
            margin: 10px auto 5px auto; position: relative; 
            overflow: hidden; border-radius: 12px; border: 2px solid #1e293b;
            box-shadow: inset 0 2px 6px rgba(0,0,0,0.6);
        }
        #zone-fill {
            height: 100%; width: 0%; 
            background: linear-gradient(90deg, var(--accent), #38bdf8);
            transition: width 0.4s cubic-bezier(0.34, 1.56, 0.64, 1), background 0.3s; 
            box-shadow: 0 0 15px var(--accent); position: relative; z-index: 1;
        }
        #zone-fill::after {
            content: ''; position: absolute; top: 0; left: 0; right: 0; height: 50%;
            background: rgba(255,255,255,0.15); border-radius: 12px 12px 0 0;
        }

        #zone-label {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 0.75rem; font-weight: 900; color: #fff; letter-spacing: 2px;
            z-index: 2; text-shadow: 0 1px 3px rgba(0,0,0,0.9); white-space: nowrap;
        }

        @keyframes bar-pulse-gold {
            0% { box-shadow: 0 0 10px var(--gold); }
            50% { box-shadow: 0 0 25px var(--gold), inset 0 0 10px var(--gold); }
            100% { box-shadow: 0 0 10px var(--gold); }
        }
        
        .zone-gold { animation: bar-pulse-gold 1.5s infinite; }

        /* --- Game Area --- */
        #game-container { flex-grow: 1; position: relative; width: 100%; overflow: hidden; }
        canvas { display: block; width: 100%; height: 100%; transition: filter 0.3s; }

        /* --- UI Overlays --- */
        .overlay { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            background: var(--glass); backdrop-filter: blur(20px); padding: 30px; 
            border-radius: 24px; text-align: center; border: 1px solid rgba(255,255,255,0.1); 
            width: 90%; max-width: 400px; z-index: 100; 
            box-shadow: 0 40px 80px -20px rgba(0, 0, 0, 0.9);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            max-height: 80vh; overflow-y: auto;
        }
        .hidden { opacity: 0; pointer-events: none; transform: translate(-50%, -45%) scale(0.95); }
        
        .action-btn { 
            background: var(--accent); color: white; border: none; padding: 18px; 
            font-size: 0.9rem; font-weight: 800; border-radius: 14px; cursor: pointer; 
            width: 100%; margin-top: 10px; transition: all 0.2s;
            text-transform: uppercase; letter-spacing: 1px;
        }
        .action-btn:active { transform: scale(0.97); }
        .secondary-btn { background: #334155; }
        .danger-btn { background: rgba(239, 68, 68, 0.1); border: 1px solid var(--fail); color: var(--fail); }
        .locked-btn { opacity: 0.5; pointer-events: none; filter: grayscale(1); }

        .analytics-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin: 15px 0; }
        .a-card { background: rgba(0,0,0,0.4); padding: 12px; border-radius: 16px; text-align: left; }
        .a-card .v { display: block; font-weight: 800; color: var(--accent); font-size: 1rem; }
        .a-card .l { font-size: 0.5rem; opacity: 0.4; text-transform: uppercase; font-weight: 700; }

        /* --- SYNC BAR UI --- */
        #sync-vis-container {
            margin: 15px 0 20px 0;
            text-align: center;
            opacity: 0; transition: opacity 0.3s;
        }
        #sync-percentage {
            font-family: monospace; font-size: 1.8rem; font-weight: 900;
            display: block; margin-bottom: 5px;
            text-shadow: 0 0 10px rgba(0,0,0,0.5);
        }
        .sync-label-mini { font-size: 0.6rem; text-transform: uppercase; letter-spacing: 2px; opacity: 0.6; }
        
        #sync-bar-bg {
            width: 100%; height: 8px; background: rgba(255,255,255,0.1);
            border-radius: 4px; overflow: hidden; position: relative;
        }
        #sync-bar-fill {
            height: 100%; width: 0%;
            background: var(--success);
            box-shadow: 0 0 15px var(--success);
            transition: width 0.6s cubic-bezier(0.22, 1, 0.36, 1);
            border-radius: 4px;
        }

        /* --- LEADERBOARD --- */
        .lb-row { 
            display: flex; align-items: center; padding: 12px 0; 
            border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 0.9rem; 
        }
        .lb-rank { width: 30px; color: var(--gold); font-weight: 900; font-size: 0.8rem; }
        .lb-name { flex-grow: 1; text-align: left; font-weight: 600; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; padding-right: 10px;}
        .lb-tier { font-size: 0.5rem; background: #1e293b; padding: 2px 6px; border-radius: 4px; margin-right: 8px; color: #94a3b8; vertical-align: middle; }
        .lb-right { text-align: right; min-width: 100px; }
        .lb-score { color: var(--accent); font-family: monospace; font-weight: 700; font-size: 1rem; display: block; }
        .lb-sub { font-size: 0.65rem; color: #94a3b8; margin-top: 2px; font-family: monospace;}
        .lb-stat { margin-left: 6px; }
        .lb-stat.peak { color: var(--hyper); }
        .lb-stat.acc { color: var(--success); }
        
        /* Auto-save indicator */
        #sync-indicator {
            position: absolute; top: 15px; left: 15px; width: 8px; height: 8px; 
            background: var(--success); border-radius: 50%; opacity: 0; transition: opacity 0.5s;
            box-shadow: 0 0 10px var(--success); pointer-events: none;
        }
        .syncing { opacity: 1 !important; }

        /* --- SYSTEM MESSAGE HUD --- */
        #system-message {
            position: absolute; top: 120px; left: 50%; transform: translateX(-50%);
            background: rgba(15, 23, 42, 0.95); border: 1px solid #334155;
            padding: 20px 30px; border-radius: 12px; z-index: 200;
            text-align: center; font-weight: 900; letter-spacing: 1px; font-size: 0.9rem;
            box-shadow: 0 10px 40px rgba(0,0,0,0.8); pointer-events: none; 
            transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            width: 85%; max-width: 450px; opacity: 0;
        }
        #system-message.visible { opacity: 1; }
        .sys-upgrade { border-color: var(--success) !important; color: var(--success); box-shadow: 0 0 30px rgba(16, 185, 129, 0.3) !important; }
        .sys-alert { border-color: var(--fail) !important; color: var(--fail); box-shadow: 0 0 30px rgba(239, 68, 68, 0.3) !important; }
        .sys-info { border-color: var(--accent) !important; color: var(--accent); box-shadow: 0 0 30px rgba(14, 165, 233, 0.3) !important; }

        /* --- INPUT STYLING --- */
        #new-agent-name, #pin-input-field {
            background: rgba(0,0,0,0.3);
            border: 2px solid #334155;
            color: var(--accent);
            padding: 15px;
            font-family: monospace;
            font-weight: 800;
            font-size: 1.2rem;
            width: 100%;
            text-align: center;
            border-radius: 8px;
            text-transform: uppercase;
            margin-bottom: 5px;
            transition: all 0.2s;
            caret-color: var(--gold);
        }
        #new-agent-name:focus, #pin-input-field:focus {
            border-color: var(--accent);
            box-shadow: 0 0 20px rgba(14, 165, 233, 0.2);
        }
        #new-agent-name::placeholder { color: rgba(255,255,255,0.2); }

        /* --- SECURE PIN UI --- */
        #pin-input-field {
            letter-spacing: 10px;
            font-size: 2rem;
            -webkit-text-security: disc; 
        }
        .pin-subtitle {
            font-size: 0.7rem; color: #94a3b8; margin-bottom: 15px; font-family: monospace;
        }

    </style>
</head>
<body>

    <div class="header">
        <div class="stat-group">
            <div class="stat" id="btn-user">
                <span class="label">AGENT</span>
                <span id="user-display" class="val">---</span>
                <span id="daily-streak-badge" style="font-size: 0.6rem; color: var(--gold);">üî• 0</span>
            </div>
            <div class="stat" id="btn-analytics">
                <span class="label">RATING</span>
                <span id="score-val" class="val xp-val">0</span>
            </div>
            <div class="stat" id="btn-analytics-2">
                <span class="label">LATENCY</span>
                <span id="speed-val" class="val">---ms</span>
            </div>
            <div class="stat" id="btn-leaderboard">
                <span class="label">GRID</span>
                <span id="mode-indicator" class="val">T1</span>
            </div>
        </div>
    </div>
    
    <div id="zone-container">
        <div id="zone-fill"></div>
        <div id="zone-label" data-mult="1.0">NEURAL SYNC: 1.0x</div>
    </div>

    <div id="game-container">
        <canvas id="gameCanvas"></canvas>
        <div id="sync-indicator"></div>

        <div id="system-message">SYSTEM READY</div>

        <div id="main-overlay" class="overlay">
            <h2 id="msg-title">NEURAL READY v4.0</h2>
            <p id="msg-body" style="margin-bottom: 15px;">Initiate flash sequence to begin calibration.</p>
            
            <div id="sync-vis-container">
                <span id="sync-percentage">0%</span>
                <span class="sync-label-mini">NEURAL EFFICIENCY</span>
                <div id="sync-bar-bg" style="margin-top: 8px;">
                    <div id="sync-bar-fill"></div>
                </div>
            </div>

            <button id="start-btn" class="action-btn">INITIATE FLASH</button>
            <button id="btn-lb-main" class="action-btn secondary-btn" style="margin-top: 10px; font-size: 0.75rem;">üåê GLOBAL GRID</button>
        </div>

        <div id="analytics-overlay" class="overlay hidden">
            <h2>SYSTEM REPORT</h2>
            <canvas id="chart-canvas" style="width: 100%; height: 100px; margin: 10px 0;"></canvas>
            <div class="analytics-grid">
                <div class="a-card"><span class="l">Peak Latency</span><span class="v" id="stat-peak">0ms</span></div>
                <div class="a-card"><span class="l">Accuracy</span><span class="v" id="stat-acc-total">0%</span></div>
                <div class="a-card"><span class="l">Grade</span><span class="v" id="stat-grade" style="color:var(--gold)">--</span></div>
                <div class="a-card"><span class="l">Uptime</span><span class="v" id="stat-uptime">0.0h</span></div>
            </div>
            <div id="analytics-actions"></div>
            <div id="analytics-danger-zone" style="margin-top: 15px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 10px;"></div>
            <button class="action-btn secondary-btn" id="btn-close-analytics" style="margin-top:10px">RETURN</button>
        </div>

        <div id="leaderboard-overlay" class="overlay hidden">
            <h2 style="color: var(--gold); letter-spacing: 2px;">GLOBAL GRID</h2>
            <div id="lb-loading" style="font-size: 0.8rem; opacity: 0.6; padding: 20px;">CONNECTING TO CORE...</div>
            <div id="lb-list" style="margin-bottom: 20px;"></div>
            <button class="action-btn" id="btn-close-lb">RETURN</button>
        </div>

        <div id="user-overlay" class="overlay hidden">
            <h3>Select Agent</h3>
            <div id="user-list" style="max-height: 200px; overflow-y: auto;"></div>
            <button class="action-btn" style="background:transparent; border: 1px dashed #444" id="btn-new-user">+ NEW / RECOVER</button>
            <button class="action-btn" style="background:#334155" id="btn-close-user">CANCEL</button>
        </div>

        <div id="new-link-overlay" class="overlay hidden">
            <h3 style="color: var(--accent); letter-spacing: 2px;">CONNECTION</h3>
            <p style="font-size: 0.8rem; opacity: 0.7; margin-bottom: 20px;">ENTER DESIGNATION TO CREATE OR RECOVER</p>
            
            <input type="text" id="new-agent-name" placeholder="AGENT_ID" maxlength="12" autocomplete="off">
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button id="btn-create-link" class="action-btn">INITIALIZE</button>
                <button id="btn-cancel-link" class="action-btn secondary-btn">ABORT</button>
            </div>
        </div>

        <div id="pin-overlay" class="overlay hidden">
            <h3 id="pin-title" style="color: var(--hyper); letter-spacing: 2px;">SECURITY CHECK</h3>
            <p id="pin-reason" class="pin-subtitle">AUTHORIZATION REQUIRED</p>
            
            <input type="password" inputmode="numeric" pattern="[0-9]*" id="pin-input-field" maxlength="4" placeholder="****" autocomplete="off">
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button id="btn-pin-confirm" class="action-btn">AUTHENTICATE</button>
                <button id="btn-pin-cancel" class="action-btn secondary-btn">CANCEL</button>
            </div>
        </div>

    </div>

<script type="module">
    /* ----------------------------------------------------
       NEURO-SPEED ELITE 4.0 [WARP ENGINE + REACTIVE BG]
       ----------------------------------------------------
    */

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, doc, setDoc, query, orderBy, limit, getDocs, getDoc, deleteDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBbUKJ9FgkTMU2WHM4N0uYAujLBDBV-ILs",
      authDomain: "neuro-speed-web.firebaseapp.com",
      projectId: "neuro-speed-web",
      storageBucket: "neuro-speed-web.firebasestorage.app",
      messagingSenderId: "314397349425",
      appId: "1:314397349425:web:992853535b9f8bd61de710"
    };

    (function() {
        // --- HONEYPOT & SECURITY ---
        window.gameScore = 0;
        let honeyPotTriggered = false;
        Object.defineProperty(window, 'gameScore', { get: () => 0, set: (val) => { console.warn("Unauthorized memory access."); honeyPotTriggered = true; } });

        let db;
        try { const app = initializeApp(firebaseConfig); db = getFirestore(app); console.log("Neuro-Link Secured."); } catch(e) { console.error("Link Error:", e); }

        const SALT = "NEURO_SECURE_SALT_9283"; 
        let appData = { users: {}, currentUser: null };
        let clickHistory = [];
        let pinResolver = null, realtimeUnsubscribe = null;

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const isTouch = ('ontouchstart' in window || navigator.maxTouchPoints > 0) && window.innerWidth < 1024;

        // --- CONSTANTS ---
        const SHAPES = ['circle', 'square', 'triangle', 'diamond', 'cross'];
        const L2_COLORS = ['#22d3ee', '#4ade80', '#f472b6', '#fbbf24'];
        const QUESTION_TIMEOUT_MS = 15000;
        
        const DIR_MAP = [
            { id: 0, key: 6, label: '6', angle: 0 },             
            { id: 1, key: 3, label: '3', angle: Math.PI*0.25 },
            { id: 2, key: 2, label: '2', angle: Math.PI*0.5 }, 
            { id: 3, key: 1, label: '1', angle: Math.PI*0.75 },
            { id: 4, key: 4, label: '4', angle: Math.PI },        
            { id: 5, key: 7, label: '7', angle: Math.PI*1.25 },
            { id: 6, key: 8, label: '8', angle: Math.PI*1.5 }, 
            { id: 7, key: 9, label: '9', angle: Math.PI*1.75 } 
        ];

        // --- GAME STATE MACHINE ---
        let gameState = {
            mode: 'IDLE', // IDLE, FLASHING, QUESTIONING
            timer: 0,     // General purpose timer (flash duration, question timeout)
            task: null,   // CENTER, SATELLITE, COLOR, DIRECTION
            selectionLock: 0, // Debounce timer
            shakeIntensity: 0
        };

        // Entities
        let centerX, centerY, minDim;
        let starfield = []; 
        let gameObjects = {
            target: null, satellite: null, distractors: [],
            uShape: null, uSat: null, uColor: null, uDir: null,
            buttons: [], ripples: []
        };
        let sessionZone = 0;

        // --- AUDIO ENGINE ---
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        const audioCtx = new AudioContext();
        
        function playTone(freq, type, duration) {
            if(audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = type; osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            gain.gain.setValueAtTime(0.05, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration);
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.start(); osc.stop(audioCtx.currentTime + duration);
        }

        // --- REACTIVE BACKGROUND SYSTEM ---
        class Star {
            constructor() { this.reset(true); }
            reset(randomZ) {
                this.x = (Math.random() - 0.5) * canvas.width * 2;
                this.y = (Math.random() - 0.5) * canvas.height * 2;
                this.z = randomZ ? Math.random() * 1000 : 1000;
                this.size = Math.random() * 2;
                this.color = Math.random() > 0.8 ? '#ffffff' : '#475569';
            }
            update(speed, dt) {
                this.z -= speed * (dt / 16);
                if (this.z <= 1) this.reset(false);
            }
            draw(ctx, cx, cy) {
                const perspective = 300 / this.z;
                const sx = cx + this.x * perspective;
                const sy = cy + this.y * perspective;
                const s = this.size * perspective;
                if(sx > 0 && sx < canvas.width && sy > 0 && sy < canvas.height) {
                    ctx.fillStyle = this.color; ctx.beginPath(); ctx.arc(sx, sy, s, 0, Math.PI*2); ctx.fill();
                }
            }
        }

        // --- MAIN LOOP (DELTA TIME ENGINE) ---
        let lastTime = 0;
        function gameLoop(timestamp) {
            const dt = timestamp - lastTime;
            lastTime = timestamp;

            update(dt);
            render(dt);
            requestAnimationFrame(gameLoop);
        }

        function update(dt) {
            // 1. Background Logic
            const u = appData.users[appData.currentUser];
            let warpSpeed = 2; // Default
            if (u) {
                // Slower reaction time (higher ms) = Slower warp. Faster reaction = Faster warp.
                const speedFactor = Math.max(0.5, (1000 - u.speed) / 50); 
                warpSpeed = speedFactor + (sessionZone * 1.5); 
                if(u.level3) warpSpeed += 5;
            }
            starfield.forEach(s => s.update(warpSpeed, dt));

            // 2. Game State Logic
            if (gameState.mode === 'FLASHING') {
                gameState.timer -= dt;
                if (gameState.timer <= 0) {
                    gameState.mode = 'QUESTIONING';
                    gameState.timer = QUESTION_TIMEOUT_MS;
                    askTask('CENTER');
                }
            } else if (gameState.mode === 'QUESTIONING') {
                if (gameState.selectionLock > 0) gameState.selectionLock -= dt;
                
                gameState.timer -= dt;
                if (gameState.timer <= 0) {
                    handleTimeout();
                }
            }

            // 3. Shake Decay
            if (gameState.shakeIntensity > 0) {
                gameState.shakeIntensity -= dt * 0.05;
                if (gameState.shakeIntensity < 0) gameState.shakeIntensity = 0;
            }

            // 4. Ripple update
            for (let i = gameObjects.ripples.length - 1; i >= 0; i--) {
                const r = gameObjects.ripples[i];
                r.radius += dt * 0.2;
                r.opacity -= dt * 0.002;
                if (r.opacity <= 0) gameObjects.ripples.splice(i, 1);
            }
        }

        function render(dt) {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Camera Shake for Singularity
            ctx.save();
            if (gameState.shakeIntensity > 0) {
                const dx = (Math.random() - 0.5) * gameState.shakeIntensity;
                const dy = (Math.random() - 0.5) * gameState.shakeIntensity;
                ctx.translate(dx, dy);
            }

            // Draw Stars
            starfield.forEach(s => s.draw(ctx, centerX, centerY));

            if (gameState.mode === 'FLASHING') {
                const u = appData.users[appData.currentUser];
                // Draw Distractors
                gameObjects.distractors.forEach(d => drawShape(d.shape, d.x, d.y, minDim * 0.05, '#334155'));
                // Draw Target
                drawShape(gameObjects.target, centerX, centerY, minDim * 0.06, '#fff');
                // Draw Satellite
                drawShape(gameObjects.satellite.shape, gameObjects.satellite.x, gameObjects.satellite.y, minDim * 0.05, 
                    u.level2 ? L2_COLORS[gameObjects.satellite.colorIdx] : '#8b5cf6');
            
            } else if (gameState.mode === 'QUESTIONING') {
                // Draw Timer Bar
                const timePct = Math.max(0, gameState.timer / QUESTION_TIMEOUT_MS);
                const barColor = timePct < 0.2 ? '#ef4444' : (timePct < 0.5 ? '#f59e0b' : '#0ea5e9');
                ctx.fillStyle = 'rgba(255,255,255,0.1)'; ctx.fillRect(0, 0, canvas.width, 6);
                ctx.fillStyle = barColor; ctx.shadowColor = barColor; ctx.shadowBlur = 10;
                ctx.fillRect(0, 0, canvas.width * timePct, 6); ctx.shadowBlur = 0;

                // Draw Text
                let title = "", sub = "";
                if(gameState.task === 'CENTER') { title = "CORE ID"; sub = "SELECT CENTER SHAPE"; }
                else if(gameState.task === 'SATELLITE') { title = "PERIPHERAL ID"; sub = "SELECT SATELLITE SHAPE"; }
                else if(gameState.task === 'COLOR') { title = "SPECTRUM ID"; sub = "MATCH SATELLITE COLOR"; }
                else { title = "VECTOR ID"; sub = "INDICATE ORIGIN"; }

                ctx.textAlign = "center"; ctx.fillStyle = "#fff";
                ctx.font = `900 ${minDim * 0.07}px 'Inter', system-ui`;
                ctx.fillText(title, centerX, centerY - minDim * 0.15);
                ctx.fillStyle = "#0ea5e9"; ctx.font = `700 ${minDim * 0.03}px monospace`;
                ctx.fillText(sub, centerX, centerY - minDim * 0.08);

                // Draw Buttons
                gameObjects.buttons.forEach(btn => {
                    const isSelected = (btn.val === gameObjects.lastSelection);
                    
                    if (gameState.task === 'DIRECTION') {
                        ctx.beginPath();
                        ctx.shadowBlur = isSelected ? 20 : 0; 
                        ctx.shadowColor = "rgba(14, 165, 233, 0.8)";
                        ctx.fillStyle = isSelected ? "rgba(14, 165, 233, 0.4)" : "rgba(255, 255, 255, 0.05)";
                        ctx.strokeStyle = isSelected ? "var(--accent)" : "#334155"; ctx.lineWidth = 3;
                        ctx.arc(btn.cx, btn.cy, btn.r, 0, Math.PI * 2);
                        ctx.fill(); ctx.stroke(); ctx.shadowBlur = 0;
                        ctx.fillStyle = isSelected ? "#fff" : "#64748b";
                        ctx.font = `800 ${minDim * 0.05}px monospace`; ctx.textBaseline = "middle";
                        ctx.fillText(btn.label, btn.cx, btn.cy); ctx.textBaseline = "alphabetic";
                    } else {
                        if (isSelected) {
                            ctx.save(); ctx.shadowBlur = 20; ctx.shadowColor = "rgba(14, 165, 233, 0.8)";
                            ctx.fillStyle = "rgba(14, 165, 233, 0.2)"; ctx.beginPath(); 
                            ctx.arc(btn.cx, btn.cy, minDim * 0.08, 0, Math.PI*2); ctx.fill(); ctx.restore();
                        }
                        if (gameState.task === 'COLOR') { 
                            ctx.fillStyle = btn.key; ctx.beginPath(); 
                            ctx.arc(btn.cx, btn.cy, minDim * 0.06, 0, Math.PI*2); ctx.fill(); 
                        } else { 
                            drawShape(btn.key, btn.cx, btn.cy, minDim * 0.05, '#fff'); 
                        }
                        if (!isTouch) {
                            ctx.fillStyle = isSelected ? "var(--accent)" : "rgba(255, 255, 255, 0.3)";
                            ctx.font = `bold ${minDim * 0.02}px monospace`;
                            ctx.fillText(`[${btn.val + 1}]`, btn.cx, btn.cy + minDim * 0.15); 
                        }
                    }
                });
            }

            // Draw Ripples
            gameObjects.ripples.forEach(r => {
                ctx.beginPath(); ctx.arc(r.x, r.y, r.radius, 0, Math.PI * 2);
                ctx.strokeStyle = `rgba(255, 255, 255, ${r.opacity})`; ctx.stroke();
            });

            ctx.restore();
        }

        // --- GAME LOGIC FUNCTIONS ---
        function executeFlash() {
            if (gameState.mode !== 'IDLE') return;
            document.getElementById('sync-vis-container').style.opacity = '0'; 
            
            const u = appData.users[appData.currentUser];
            gameState.mode = 'FLASHING';
            gameState.timer = u.speed; // Flash duration based on user speed

            // Setup Shapes
            gameObjects.target = SHAPES[Math.floor(Math.random() * SHAPES.length)];
            const sShape = SHAPES[Math.floor(Math.random() * SHAPES.length)];
            const sColorIdx = u.level2 ? Math.floor(Math.random() * L2_COLORS.length) : -1;
            const sDirIdx = Math.floor(Math.random() * 8); 
            
            const radius = minDim * 0.35;
            const angle = u.level3 ? DIR_MAP[sDirIdx].angle : Math.random() * Math.PI * 2;
            const satX = centerX + Math.cos(angle) * radius; 
            const satY = centerY + Math.sin(angle) * radius;

            gameObjects.satellite = { shape: sShape, x: satX, y: satY, colorIdx: sColorIdx, dirIdx: sDirIdx };
            
            // Setup Distractors
            gameObjects.distractors = [];
            const count = 12; const step = (Math.PI * 2) / count;
            for (let i = 0; i < count; i++) {
                const a = i * step;
                if (Math.abs(Math.atan2(Math.sin(a - angle), Math.cos(a - angle))) > 0.6) {
                    gameObjects.distractors.push({
                        x: centerX + Math.cos(a) * radius + (Math.random()-0.5)*20,
                        y: centerY + Math.sin(a) * radius + (Math.random()-0.5)*20,
                        shape: SHAPES[Math.floor(Math.random() * SHAPES.length)]
                    });
                }
            }
            playTone(440, 'sine', 0.1);
        }

        function askTask(type) {
            gameState.task = type;
            gameObjects.buttons = [];
            gameObjects.lastSelection = -1;
            
            if (type === 'DIRECTION') {
                const layoutRadius = minDim * 0.3; 
                DIR_MAP.forEach(dir => {
                    gameObjects.buttons.push({
                        key: dir.key, val: dir.id, label: dir.label,
                        cx: centerX + Math.cos(dir.angle) * layoutRadius,
                        cy: centerY + Math.sin(dir.angle) * layoutRadius,
                        r: minDim * 0.07
                    });
                });
            } else {
                const items = (type === 'CENTER' || type === 'SATELLITE') ? SHAPES : L2_COLORS;    
                const rowWidth = canvas.width * 0.85; 
                const spacing = rowWidth / (items.length - 1); 
                const startX = (canvas.width - rowWidth) / 2;
                items.forEach((item, i) => {
                    gameObjects.buttons.push({
                        key: item, val: i, cx: startX + (i * spacing), cy: centerY + 60, r: minDim * 0.08
                    });
                });
            }
        }

        function handleInput(e) {
            if (gameState.mode !== 'QUESTIONING' || gameState.selectionLock > 0) return;
            const rect = canvas.getBoundingClientRect();
            const clientX = e.clientX || (e.touches && e.touches.length > 0 ? e.touches[0].clientX : 0);
            const clientY = e.clientY || (e.touches && e.touches.length > 0 ? e.touches[0].clientY : 0);
            const x = clientX - rect.left;
            const y = clientY - rect.top;

            // Touch Ripple
            gameObjects.ripples.push({ x: x, y: y, radius: 0, opacity: 1 });

            // Hit Test
            let hit = null;
            if (gameState.task === 'DIRECTION') {
                hit = gameObjects.buttons.find(b => Math.hypot(b.cx - x, b.cy - y) < b.r * 1.5);
            } else {
                hit = gameObjects.buttons.find(b => Math.hypot(b.cx - x, b.cy - y) < b.r * 1.5);
            }

            if (hit) {
                // Honeypot check
                const dist = Math.sqrt(Math.pow(hit.cx - x, 2) + Math.pow(hit.cy - y, 2));
                clickHistory.push(dist); if(clickHistory.length > 10) clickHistory.shift();
                const variance = clickHistory.reduce((a, b) => a + b, 0) / clickHistory.length;
                if (clickHistory.length >= 5 && variance < 2.0) { console.warn("Bot?"); honeyPotTriggered = true; }

                gameObjects.lastSelection = hit.val;
                gameState.selectionLock = 320; // 320ms debounce
                
                // Process Answer logic
                const u = appData.users[appData.currentUser];
                playTone(800, 'triangle', 0.05);

                setTimeout(() => {
                    if (gameState.task === 'CENTER') { 
                        gameObjects.uShape = hit.key; askTask('SATELLITE'); 
                    } else if (gameState.task === 'SATELLITE') {
                        gameObjects.uSat = hit.key;
                        if (u.level2) askTask('COLOR'); 
                        else if (u.level3) askTask('DIRECTION');
                        else finalizeTrial();
                    } else if (gameState.task === 'COLOR') { 
                        gameObjects.uColor = hit.val; 
                        if (u.level3) askTask('DIRECTION'); else finalizeTrial();
                    } else if (gameState.task === 'DIRECTION') { 
                        gameObjects.uDir = hit.val; finalizeTrial(); 
                    }
                }, 300);
            }
        }

        function handleTimeout() {
            triggerSystemMessage("NEURAL LINK SEVERED (TIMEOUT)", "alert");
            gameObjects.uShape = null; 
            finalizeTrial(true);
        }

        function finalizeTrial(timedOut = false) {
            if (honeyPotTriggered) { appData.users[appData.currentUser].score = 0; location.reload(); return; }

            const u = appData.users[appData.currentUser];
            let correct = (gameObjects.uShape === gameObjects.target && gameObjects.uSat === gameObjects.satellite.shape);
            if (u.level2 && gameObjects.uColor !== gameObjects.satellite.colorIdx) correct = false;
            if (u.level3 && gameObjects.uDir !== gameObjects.satellite.dirIdx) correct = false;
            if (timedOut) correct = false;

            gameState.mode = 'IDLE';

            // VISUAL & SCORING LOGIC
            const prevSpeed = u.speed;
            
            if (correct) {
                sessionZone++;
                playTone(1200, 'sine', 0.2); // Success Sound
                
                if (sessionZone > 10) gameState.shakeIntensity = 20; // Singularity Shake

                // Score Calc
                let performanceVal = Math.max(100, (1500 - u.speed)); 
                let tierMult = u.level3 ? 2.5 : (u.level2 ? 1.5 : 1.0);
                let zoneMult = sessionZone > 10 ? 1.5 : (sessionZone > 5 ? 1.2 : 1.0);
                let roundTarget = performanceVal * tierMult * zoneMult * 10;
                
                u.score = (u.score || 0) + ((roundTarget - (u.score || 0)) * 0.15);
                u.streak = Math.max(0, u.streak) + 1;

                if (u.streak >= 3) { 
                    u.speed = Math.max(16, u.speed * 0.92); 
                    u.streak = 0; 
                    if (!u.level2 && u.speed <= 350) { u.level2 = true; u.speed = 400; triggerSystemMessage("TIER 2 UNLOCKED", 'upgrade'); }
                    else if (u.level2 && !u.level3 && u.speed <= 220) { u.level3 = true; u.speed = 300; triggerSystemMessage("TIER 3 UNLOCKED", 'upgrade'); }
                }
                
                document.getElementById('msg-title').innerText = "SYNC STABLE";
                document.getElementById('msg-title').style.color = "#10b981";
                document.getElementById('msg-body').innerText = `RATING: ${Math.floor(u.score)}`;

            } else {
                playTone(150, 'sawtooth', 0.4); // Failure Sound
                sessionZone = 0;
                let penalty = u.score * 0.20; 
                u.score = Math.max(0, u.score - penalty); 
                u.streak = Math.min(0, u.streak) - 1;
                u.speed = Math.min(1000, u.speed + 80); 

                document.getElementById('msg-title').innerText = timedOut ? "SYNC TIMEOUT" : "SYNC LOST";
                document.getElementById('msg-title').style.color = "#ef4444";
                document.getElementById('msg-body').innerText = `RATING DROP: -${Math.floor(penalty)}`;

                if (u.streak <= -3 && (u.level2 || u.level3)) {
                    if (u.level3) { u.level3 = false; triggerSystemMessage("TIER 3 REVOKED", 'alert'); }
                    else { u.level2 = false; triggerSystemMessage("TIER 2 REVOKED", 'alert'); }
                    u.streak = 0; u.speed += 100;
                }
            }

            // Sync Bar Render
            const maxLatency = 1000;
            const oldPct = Math.max(0, Math.min(100, ((maxLatency - prevSpeed) / maxLatency) * 100));
            const newPct = Math.max(0, Math.min(100, ((maxLatency - u.speed) / maxLatency) * 100));
            
            const barVis = document.getElementById('sync-vis-container');
            const barFill = document.getElementById('sync-bar-fill');
            const pctText = document.getElementById('sync-percentage');
            
            barVis.style.opacity = '1';
            const themeColor = correct ? 'var(--success)' : 'var(--fail)';
            barFill.style.background = themeColor; barFill.style.boxShadow = `0 0 15px ${themeColor}`;
            pctText.style.color = themeColor;
            barFill.style.transition = 'none'; barFill.style.width = `${oldPct}%`; pctText.innerText = `${Math.round(oldPct)}%`;
            setTimeout(() => {
                barFill.style.transition = 'width 0.6s cubic-bezier(0.22, 1, 0.36, 1)';
                barFill.style.width = `${newPct}%`; pctText.innerText = `${Math.round(newPct)}%`;
            }, 50);

            u.history.push(Math.round(u.speed));
            u.resultsHistory.push({ correct, date: new Date().toISOString().split('T')[0] });
            save(); updateUI();
            
            // Background Save
            const startBtn = document.getElementById('start-btn');
            startBtn.classList.add('locked-btn');
            document.getElementById('main-overlay').classList.remove('hidden');
            backgroundSync().then(() => setTimeout(() => startBtn.classList.remove('locked-btn'), 600));
        }

        // --- HELPER FUNCTIONS ---
        function drawShape(type, x, y, size, color) {
            ctx.beginPath(); ctx.fillStyle = color;
            if (type === 'circle') ctx.arc(x, y, size, 0, Math.PI * 2);
            else if (type === 'square') ctx.rect(x - size, y - size, size * 2, size * 2);
            else if (type === 'triangle') { ctx.moveTo(x, y - size); ctx.lineTo(x + size, y + size); ctx.lineTo(x - size, y + size); ctx.closePath(); }
            else if (type === 'diamond') { ctx.moveTo(x, y - size * 1.2); ctx.lineTo(x + size * 1.2, y); ctx.lineTo(x, y + size * 1.2); ctx.lineTo(x - size * 1.2, y); ctx.closePath(); }
            else if (type === 'cross') { ctx.rect(x - size/3, y - size, size/1.5, size * 2); ctx.rect(x - size, y - size/3, size * 2, size/1.5); }
            ctx.fill();
        }

        // --- DATA & SYNC ---
        function generateHash(data) {
            const str = JSON.stringify(data) + SALT;
            let hash = 0; for (let i = 0; i < str.length; i++) hash = ((hash << 5) - hash) + str.charCodeAt(i);
            return hash.toString();
        }
        function save() {
            if (honeyPotTriggered) return;
            localStorage.setItem('neuroElite_v4_secure', JSON.stringify(appData));
            localStorage.setItem('neuroElite_sig_v4', generateHash(appData));
        }
        function load() {
            const saved = localStorage.getItem('neuroElite_v4_secure');
            const sig = localStorage.getItem('neuroElite_sig_v4');
            if (saved && sig && generateHash(JSON.parse(saved)) === sig) appData = JSON.parse(saved);
            else { localStorage.clear(); appData = { users: {}, currentUser: null }; }
            
            if (appData.currentUser) { checkDailyStreak(); updateUI(); initRealtimeSync(appData.currentUser); } 
            else showUserMenu();
        }
        function checkDailyStreak() {
            const u = appData.users[appData.currentUser];
            const today = new Date().toISOString().split('T')[0];
            if (!u.lastPlayDate) { u.lastPlayDate = today; u.dailyStreak = 1; }
            else if (u.lastPlayDate !== today) {
                const diff = (new Date(today) - new Date(u.lastPlayDate)) / 86400000;
                if (diff >= 0.9 && diff < 2) u.dailyStreak++; else if (diff >= 2) u.dailyStreak = 1;
                u.lastPlayDate = today;
            }
            save();
        }
        function initRealtimeSync(userId) {
            if (realtimeUnsubscribe) realtimeUnsubscribe();
            if (!db || !userId) return;
            realtimeUnsubscribe = onSnapshot(doc(db, "leaderboard", userId), (docSnap) => {
                if (docSnap.exists() && !docSnap.metadata.hasPendingWrites) {
                    const c = docSnap.data(); const u = appData.users[userId];
                    if (gameState.mode === 'IDLE' && u && (c.score !== u.score || c.speed !== u.speed)) {
                        u.score = c.score || 0; u.speed = c.speed;
                        u.level2 = (u.speed <= 400); u.level3 = (u.speed <= 300);
                        if(c.pin && u.pin !== c.pin) u.pin = c.pin;
                        save(); updateUI(); triggerSystemMessage("REMOTE SYNC DETECTED", "info");
                    }
                }
            });
        }
        function backgroundSync() {
            if (!appData.currentUser || honeyPotTriggered || appData.users[appData.currentUser].speed < 100) return Promise.resolve();
            const u = appData.users[appData.currentUser];
            const ind = document.getElementById('sync-indicator'); ind.classList.add('syncing');
            const total = u.resultsHistory.length;
            const correct = u.resultsHistory.filter(r => r.correct).length;
            const accuracy = total > 0 ? Math.round((correct / total) * 100) : 0;
            return setDoc(doc(db, "leaderboard", appData.currentUser), {
                name: appData.currentUser, score: Math.floor(u.score), speed: Math.round(u.speed),
                accuracy: accuracy, tier: u.level3 ? "T3" : (u.level2 ? "T2" : "T1"),
                timestamp: new Date(), pin: u.pin || null
            }, { merge: true }).then(() => setTimeout(() => ind.classList.remove('syncing'), 500))
            .catch(() => ind.classList.remove('syncing'));
        }

        // --- UI FUNCTIONS ---
        function updateUI() {
            const u = appData.users[appData.currentUser];
            if(!u) return;
            if (!u.peakScore) u.peakScore = 0; if (u.score > u.peakScore) u.peakScore = u.score;
            document.getElementById('user-display').innerText = appData.currentUser;
            const currentDisplay = Math.floor(u.score || 0);
            const scoreEl = document.getElementById('score-val');
            scoreEl.innerText = currentDisplay.toLocaleString();
            if (currentDisplay < u.peakScore * 0.5) scoreEl.style.color = 'var(--fail)';
            else if (currentDisplay > u.peakScore * 0.9) scoreEl.style.color = 'var(--success)';
            else scoreEl.style.color = 'var(--gold)';
            document.getElementById('speed-val').innerText = Math.round(u.speed) + 'ms';
            document.getElementById('daily-streak-badge').innerText = `üî• ${u.dailyStreak || 0}`;
            document.getElementById('mode-indicator').innerText = u.level3 ? "T3" : (u.level2 ? "T2" : "T1");
            
            const fill = document.getElementById('zone-fill');
            const label = document.getElementById('zone-label');
            const percentage = Math.min(sessionZone * 10, 100);
            fill.style.width = percentage + "%";
            
            if (sessionZone >= 10) {
                fill.style.background = "linear-gradient(90deg, #f59e0b, #ef4444)"; fill.classList.add('zone-gold');
                label.innerText = "SINGULARITY: MAX"; canvas.classList.add('singularity-glow');
            } else if (sessionZone >= 5) {
                fill.style.background = "linear-gradient(90deg, #a855f7, #ec4899)"; fill.classList.add('zone-gold');
                label.innerText = "OVERCLOCK: ACTIVE"; canvas.classList.remove('singularity-glow');
            } else {
                fill.style.background = "linear-gradient(90deg, var(--accent), #38bdf8)"; fill.classList.remove('zone-gold');
                label.innerText = `SYNC STREAK: ${sessionZone}`; canvas.classList.remove('singularity-glow');
            }
        }

        function triggerSystemMessage(text, type) {
            const el = document.getElementById('system-message');
            el.innerText = text; el.className = 'visible'; 
            if(type === 'upgrade') el.classList.add('sys-upgrade'); 
            else if(type === 'info') el.classList.add('sys-info');
            else el.classList.add('sys-alert');
            setTimeout(() => el.classList.remove('visible'), 3500);
        }

        function requestPin(title, reason) {
            return new Promise((resolve) => {
                hideOverlays();
                document.getElementById('pin-overlay').classList.remove('hidden');
                document.getElementById('pin-title').innerText = title || "SECURITY CHECK";
                document.getElementById('pin-reason').innerText = reason || "ENTER KEY";
                const input = document.getElementById('pin-input-field'); input.value = "";
                setTimeout(() => input.focus(), 100);
                pinResolver = resolve;
            });
        }
        
        function hideOverlays() { document.querySelectorAll('.overlay').forEach(o => o.classList.add('hidden')); }
        function showUserMenu() {
            if(realtimeUnsubscribe) { realtimeUnsubscribe(); realtimeUnsubscribe = null; }
            hideOverlays(); document.getElementById('user-overlay').classList.remove('hidden');
            const list = document.getElementById('user-list'); list.innerHTML = '';
            Object.keys(appData.users).forEach(name => {
                const btn = document.createElement('div'); btn.className = 'a-card';
                btn.style.marginBottom = '8px'; btn.style.cursor = 'pointer';
                const s = appData.users[name].score ? Math.floor(appData.users[name].score) : 0;
                btn.innerHTML = `<span class="l">${name}</span><span class="v" style="color:var(--gold)">${s} Rating</span>`;
                btn.onclick = () => { 
                    appData.currentUser = name; sessionZone = 0; checkDailyStreak(); updateUI(); hideOverlays(); 
                    document.getElementById('main-overlay').classList.remove('hidden'); initRealtimeSync(name);
                };
                list.appendChild(btn);
            });
        }

        // --- EVENTS ---
        document.getElementById('start-btn').onclick = () => { hideOverlays(); setTimeout(executeFlash, 300); };
        document.getElementById('btn-user').onclick = showUserMenu;
        document.getElementById('btn-close-user').onclick = () => { if(appData.currentUser) { hideOverlays(); document.getElementById('main-overlay').classList.remove('hidden'); } };
        document.getElementById('btn-new-user').onclick = () => { hideOverlays(); document.getElementById('new-link-overlay').classList.remove('hidden'); document.getElementById('new-agent-name').value = ''; };
        document.getElementById('btn-cancel-link').onclick = () => { hideOverlays(); if(appData.currentUser) document.getElementById('main-overlay').classList.remove('hidden'); else showUserMenu(); };
        document.getElementById('btn-leaderboard').onclick = async () => {
            hideOverlays(); document.getElementById('leaderboard-overlay').classList.remove('hidden');
            const list = document.getElementById('lb-list'); list.innerHTML = "";
            document.getElementById('lb-loading').style.display = 'block';
            try {
                const q = query(collection(db, "leaderboard"), orderBy("score", "desc"), limit(20));
                const snap = await getDocs(q);
                document.getElementById('lb-loading').style.display = 'none';
                let rank = 1;
                snap.forEach((doc) => {
                    const d = doc.data();
                    const acc = d.accuracy !== undefined ? d.accuracy + "%" : "--";
                    const isSecure = d.pin ? "üîí" : "";
                    const row = document.createElement('div'); row.className = 'lb-row';
                    row.innerHTML = `<div class="lb-rank">${rank++}</div><div class="lb-name"><span class="lb-tier">${d.tier}</span>${d.name} <span style="font-size:0.7em">${isSecure}</span></div><div class="lb-right"><span class="lb-score">${d.score.toLocaleString()}</span><div class="lb-sub"><span class="lb-stat peak">‚ö°${d.speed}ms</span><span class="lb-stat acc">üéØ${acc}</span></div></div>`;
                    list.appendChild(row);
                });
            } catch(e) { document.getElementById('lb-loading').innerText = "CONNECTION FAILURE"; }
        };
        document.getElementById('btn-close-lb').onclick = () => { hideOverlays(); document.getElementById('main-overlay').classList.remove('hidden'); };
        
        // Pin Events
        document.getElementById('btn-pin-confirm').onclick = () => { if (pinResolver) { pinResolver(document.getElementById('pin-input-field').value); pinResolver = null; } hideOverlays(); };
        document.getElementById('btn-pin-cancel').onclick = () => { if (pinResolver) { pinResolver(null); pinResolver = null; } hideOverlays(); };

        // Create/Recover User
        document.getElementById('btn-create-link').onclick = async () => {
            const n = document.getElementById('new-agent-name').value.trim().toUpperCase();
            if (!n) return;
            if (appData.users[n]) { alert("EXISTS"); return; }
            const btn = document.getElementById('btn-create-link'); btn.innerText = "SCANNING...";
            try {
                const snap = await getDoc(doc(db, "leaderboard", n));
                if (snap.exists()) {
                    const d = snap.data();
                    if (d.pin) {
                        const entered = await requestPin("RECOVERY MODE", `AGENT ${n} DETECTED.`);
                        if (entered !== d.pin) { alert("INVALID"); return; }
                    }
                    appData.users[n] = { speed: d.speed || 450, score: d.score || 0, peakScore: d.score || 0, streak: 0, history: [d.speed], resultsHistory: [], level2: d.tier === 'T2', level3: d.tier === 'T3', totalTimeMs: 0, dailyStreak: 0, lastPlayDate: null, pin: d.pin };
                    triggerSystemMessage("LINK RESTORED", "upgrade");
                } else {
                    let pin = await requestPin("NEW LINK", "SET PIN (OPTIONAL)");
                    appData.users[n] = { speed: 450, score: 0, peakScore: 0, streak: 0, history: [450], resultsHistory: [], level2: false, level3: false, totalTimeMs: 0, dailyStreak: 0, lastPlayDate: null, pin: pin === "" ? null : pin };
                }
                appData.currentUser = n; sessionZone = 0; save(); updateUI(); hideOverlays(); 
                document.getElementById('main-overlay').classList.remove('hidden'); initRealtimeSync(n); backgroundSync();
            } catch(e) { console.error(e); }
        };

        // Inputs
        window.addEventListener('resize', () => { canvas.width = window.innerWidth; canvas.height = window.innerHeight - 96; centerX = canvas.width/2; centerY = canvas.height/2; minDim = Math.min(canvas.width, canvas.height); });
        canvas.addEventListener('mousedown', handleInput);
        canvas.addEventListener('touchstart', (e) => { e.preventDefault(); handleInput(e); }, {passive: false});
        window.addEventListener('keydown', (e) => {
            if (gameState.mode !== 'QUESTIONING' || gameState.selectionLock > 0) return;
            if (gameState.task === 'DIRECTION') {
                const k = parseInt(e.key);
                if (!isNaN(k)) {
                    const h = gameObjects.buttons.find(b => b.key === k);
                    if(h) { gameObjects.ripples.push({x:h.cx,y:h.cy,radius:0,opacity:1}); gameObjects.buttons.forEach(b => { if(b===h) handleInput({clientX: h.cx, clientY: h.cy + canvas.getBoundingClientRect().top}); }); }
                }
            } else {
                const i = parseInt(e.key) - 1;
                if (i >= 0 && i < gameObjects.buttons.length) {
                   const h = gameObjects.buttons[i];
                   gameObjects.ripples.push({x:h.cx,y:h.cy,radius:0,opacity:1});
                   handleInput({clientX: h.cx, clientY: h.cy + canvas.getBoundingClientRect().top});
                }
            }
        });

        // INIT
        window.dispatchEvent(new Event('resize'));
        load();
        
        // Init Starfield
        for(let i=0; i<60; i++) starfield.push(new Star());
        
        // Start Loop
        requestAnimationFrame(gameLoop);

    })();
</script>
</body>
</html>
