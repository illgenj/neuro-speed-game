<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Neuro-Speed Elite 4.2</title>
    <style>
        :root { 
            --bg: #020617; --panel: #0f172a; --accent: #0ea5e9; --text: #f8fafc; 
            --success: #10b981; --fail: #ef4444; --gold: #f59e0b; --quantum: #a855f7; 
            --hyper: #f43f5e; --glass: rgba(15, 23, 42, 0.96);
        }
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; user-select: none; }
        
        body { 
            background: var(--bg); color: var(--text); 
            font-family: 'Inter', system-ui, -apple-system, sans-serif; 
            margin: 0; display: flex; flex-direction: column; 
            height: 100vh; overflow: hidden; touch-action: none; 
        }

        /* --- Header & Interactive Stats --- */
        .header { 
            height: 90px; width: 100%; display: flex; align-items: center; 
            background: var(--panel); border-bottom: 2px solid #1e293b; 
            z-index: 50; flex-shrink: 0;
        }
        .stat-group { display: flex; flex-grow: 1; justify-content: space-around; height: 100%; }
        
        .stat { 
            text-align: center; display: flex; flex-direction: column; 
            justify-content: center; padding: 0 5px; cursor: pointer; 
            transition: all 0.2s; min-width: 60px;
        }
        
        .label { font-size: 0.5rem; text-transform: uppercase; opacity: 0.4; letter-spacing: 1.2px; margin-bottom: 2px; font-weight: 700; }
        .val { font-size: 0.85rem; font-weight: 800; color: var(--accent); font-family: monospace; }
        .xp-val { color: var(--gold); transition: color 0.3s; }

        /* Audio Toggle */
        #btn-audio { opacity: 0.5; }
        #btn-audio.active { opacity: 1; color: var(--success); }

        /* --- ZONE THERMOMETER --- */
        #zone-container {
            width: 90%; height: 24px; background: #0f172a; 
            margin: 10px auto 5px auto; position: relative; 
            overflow: hidden; border-radius: 12px; border: 2px solid #1e293b;
            box-shadow: inset 0 2px 6px rgba(0,0,0,0.6);
        }
        #zone-fill {
            height: 100%; width: 0%; 
            background: linear-gradient(90deg, var(--accent), #38bdf8);
            transition: width 0.4s cubic-bezier(0.34, 1.56, 0.64, 1), background 0.3s; 
            box-shadow: 0 0 15px var(--accent); position: relative; z-index: 1;
        }
        #zone-fill::after {
            content: ''; position: absolute; top: 0; left: 0; right: 0; height: 50%;
            background: rgba(255,255,255,0.15); border-radius: 12px 12px 0 0;
        }

        #zone-label {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 0.75rem; font-weight: 900; color: #fff; letter-spacing: 2px;
            z-index: 2; text-shadow: 0 1px 3px rgba(0,0,0,0.9); white-space: nowrap;
        }

        @keyframes bar-pulse-gold {
            0% { box-shadow: 0 0 10px var(--gold); }
            50% { box-shadow: 0 0 25px var(--gold), inset 0 0 10px var(--gold); }
            100% { box-shadow: 0 0 10px var(--gold); }
        }
        @keyframes text-pop {
            0% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.4); color: #fff; }
            100% { transform: translate(-50%, -50%) scale(1); }
        }
        
        .zone-gold { animation: bar-pulse-gold 1.5s infinite; }
        .text-pop-anim { animation: text-pop 0.3s ease-out; }

        /* --- Game Area --- */
        #game-container { flex-grow: 1; position: relative; width: 100%; overflow: hidden; }
        canvas { display: block; width: 100%; height: 100%; transition: filter 0.3s; }

        /* --- UI Overlays --- */
        .overlay { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            background: var(--glass); backdrop-filter: blur(20px); padding: 30px; 
            border-radius: 24px; text-align: center; border: 1px solid rgba(255,255,255,0.1); 
            width: 90%; max-width: 400px; z-index: 100; 
            box-shadow: 0 40px 80px -20px rgba(0, 0, 0, 0.9);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            max-height: 80vh; overflow-y: auto;
        }
        .hidden { opacity: 0; pointer-events: none; transform: translate(-50%, -45%) scale(0.95); }
        
        .action-btn { 
            background: var(--accent); color: white; border: none; padding: 18px; 
            font-size: 0.9rem; font-weight: 800; border-radius: 14px; cursor: pointer; 
            width: 100%; margin-top: 10px; transition: all 0.2s;
            text-transform: uppercase; letter-spacing: 1px;
        }
        .action-btn:active { transform: scale(0.97); }
        .secondary-btn { background: #334155; }
        .danger-btn { background: rgba(239, 68, 68, 0.1); border: 1px solid var(--fail); color: var(--fail); }
        .locked-btn { opacity: 0.5; pointer-events: none; filter: grayscale(1); }

        .analytics-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin: 15px 0; }
        .a-card { background: rgba(0,0,0,0.4); padding: 12px; border-radius: 16px; text-align: left; }
        .a-card .v { display: block; font-weight: 800; color: var(--accent); font-size: 1rem; }
        .a-card .l { font-size: 0.5rem; opacity: 0.4; text-transform: uppercase; font-weight: 700; }

        /* --- NEW SYNC BAR UI --- */
        #sync-vis-container {
            margin: 15px 0 20px 0;
            text-align: center;
            opacity: 0; transition: opacity 0.3s;
        }
        #sync-percentage {
            font-family: monospace; font-size: 1.8rem; font-weight: 900;
            display: block; margin-bottom: 5px;
            text-shadow: 0 0 10px rgba(0,0,0,0.5);
        }
        .sync-label-mini { font-size: 0.6rem; text-transform: uppercase; letter-spacing: 2px; opacity: 0.6; }
        
        #sync-bar-bg {
            width: 100%; height: 8px; background: rgba(255,255,255,0.1);
            border-radius: 4px; overflow: hidden; position: relative;
        }
        #sync-bar-fill {
            height: 100%; width: 0%;
            background: var(--success);
            box-shadow: 0 0 15px var(--success);
            transition: width 0.6s cubic-bezier(0.22, 1, 0.36, 1);
            border-radius: 4px;
        }

        /* --- LEADERBOARD --- */
        .lb-row { 
            display: flex; align-items: center; padding: 12px 0; 
            border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 0.9rem; 
        }
        .lb-rank { width: 30px; color: var(--gold); font-weight: 900; font-size: 0.8rem; }
        .lb-name { flex-grow: 1; text-align: left; font-weight: 600; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; padding-right: 10px;}
        .lb-tier { font-size: 0.5rem; background: #1e293b; padding: 2px 6px; border-radius: 4px; margin-right: 8px; color: #94a3b8; vertical-align: middle; }
        .lb-right { text-align: right; min-width: 100px; }
        .lb-score { color: var(--accent); font-family: monospace; font-weight: 700; font-size: 1rem; display: block; }
        .lb-sub { font-size: 0.65rem; color: #94a3b8; margin-top: 2px; font-family: monospace;}
        .lb-stat { margin-left: 6px; }
        .lb-stat.peak { color: var(--hyper); }
        .lb-stat.acc { color: var(--success); }
        
        /* Auto-save indicator */
        #sync-indicator {
            position: absolute; top: 15px; left: 15px; width: 8px; height: 8px; 
            background: var(--success); border-radius: 50%; opacity: 0; transition: opacity 0.5s;
            box-shadow: 0 0 10px var(--success); pointer-events: none;
        }
        .syncing { opacity: 1 !important; }

        .singularity-glow { filter: saturate(1.5) contrast(1.1); }

        /* --- SYSTEM MESSAGE HUD --- */
        #system-message {
            position: absolute; top: 120px; left: 50%; transform: translateX(-50%);
            background: rgba(15, 23, 42, 0.95); border: 1px solid #334155;
            padding: 20px 30px; border-radius: 12px; z-index: 200;
            text-align: center; font-weight: 900; letter-spacing: 1px; font-size: 0.9rem;
            box-shadow: 0 10px 40px rgba(0,0,0,0.8); pointer-events: none; 
            transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            width: 85%; max-width: 450px;
        }
        .sys-upgrade { border-color: var(--success) !important; color: var(--success); box-shadow: 0 0 30px rgba(16, 185, 129, 0.3) !important; }
        .sys-alert { border-color: var(--fail) !important; color: var(--fail); box-shadow: 0 0 30px rgba(239, 68, 68, 0.3) !important; }
        .sys-info { border-color: var(--accent) !important; color: var(--accent); box-shadow: 0 0 30px rgba(14, 165, 233, 0.3) !important; }

        /* --- INPUT STYLING --- */
        #new-agent-name, #pin-input-field {
            background: rgba(0,0,0,0.3);
            border: 2px solid #334155;
            color: var(--accent);
            padding: 15px;
            font-family: monospace;
            font-weight: 800;
            font-size: 1.2rem;
            width: 100%;
            text-align: center;
            border-radius: 8px;
            text-transform: uppercase;
            margin-bottom: 5px;
            transition: all 0.2s;
            caret-color: var(--gold);
        }
        #new-agent-name:focus, #pin-input-field:focus {
            border-color: var(--accent);
            box-shadow: 0 0 20px rgba(14, 165, 233, 0.2);
        }
        #new-agent-name::placeholder { color: rgba(255,255,255,0.2); }

        /* --- SECURE PIN UI --- */
        #pin-input-field {
            letter-spacing: 10px;
            font-size: 2rem;
            -webkit-text-security: disc; /* Makes it look like password dots but styled */
        }
        .pin-subtitle {
            font-size: 0.7rem; color: #94a3b8; margin-bottom: 15px; font-family: monospace;
        }

    </style>
</head>
<body>

    <div class="header">
        <div class="stat-group">
            <div class="stat" id="btn-user">
                <span class="label">AGENT</span>
                <span id="user-display" class="val">---</span>
                <span id="daily-streak-badge" style="font-size: 0.6rem; color: var(--gold);">üî• 0</span>
            </div>
            <div class="stat" id="btn-analytics">
                <span class="label">RATING</span>
                <span id="score-val" class="val xp-val">0</span>
            </div>
            <div class="stat" id="btn-analytics-2">
                <span class="label">LATENCY</span>
                <span id="speed-val" class="val">---ms</span>
            </div>
            <div class="stat" id="btn-audio">
                <span class="label">AUDIO</span>
                <span id="audio-icon" class="val">OFF</span>
            </div>
            <div class="stat" id="btn-leaderboard">
                <span class="label">GRID</span>
                <span id="mode-indicator" class="val">T1</span>
            </div>
        </div>
    </div>
    
    <div id="zone-container">
        <div id="zone-fill"></div>
        <div id="zone-label" data-mult="1.0">NEURAL SYNC: 1.0x</div>
    </div>

    <div id="game-container">
        <canvas id="gameCanvas"></canvas>
        <div id="sync-indicator"></div>

        <div id="system-message" class="hidden">SYSTEM READY</div>

        <div id="main-overlay" class="overlay">
            <h2 id="msg-title">NEURAL READY</h2>
            <p id="msg-body" style="margin-bottom: 15px;">Initiate flash sequence to begin calibration.</p>
            
            <div id="sync-vis-container">
                <span id="sync-percentage">0%</span>
                <span class="sync-label-mini">NEURAL EFFICIENCY</span>
                <div id="sync-bar-bg" style="margin-top: 8px;">
                    <div id="sync-bar-fill"></div>
                </div>
            </div>

            <button id="start-btn" class="action-btn">INITIATE FLASH</button>
            <button id="btn-lb-main" class="action-btn secondary-btn" style="margin-top: 10px; font-size: 0.75rem;">üåê GLOBAL GRID</button>
        </div>

        <div id="analytics-overlay" class="overlay hidden">
            <h2>SYSTEM REPORT</h2>
            <canvas id="chart-canvas" style="width: 100%; height: 100px; margin: 10px 0;"></canvas>
            <div class="analytics-grid">
                <div class="a-card"><span class="l">Peak Latency</span><span class="v" id="stat-peak">0ms</span></div>
                <div class="a-card"><span class="l">Accuracy</span><span class="v" id="stat-acc-total">0%</span></div>
                <div class="a-card"><span class="l">Grade</span><span class="v" id="stat-grade" style="color:var(--gold)">--</span></div>
                <div class="a-card"><span class="l">Uptime</span><span class="v" id="stat-uptime">0.0h</span></div>
            </div>
            <div id="analytics-actions"></div>
            <div id="analytics-danger-zone" style="margin-top: 15px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 10px;"></div>
            <button class="action-btn secondary-btn" id="btn-close-analytics" style="margin-top:10px">RETURN</button>
        </div>

        <div id="leaderboard-overlay" class="overlay hidden">
            <h2 style="color: var(--gold); letter-spacing: 2px;">GLOBAL GRID</h2>
            <div id="lb-loading" style="font-size: 0.8rem; opacity: 0.6; padding: 20px;">CONNECTING TO CORE...</div>
            <div id="lb-list" style="margin-bottom: 20px;"></div>
            <button class="action-btn" id="btn-close-lb">RETURN</button>
        </div>

        <div id="user-overlay" class="overlay hidden">
            <h3>Select Agent</h3>
            <div id="user-list" style="max-height: 200px; overflow-y: auto;"></div>
            <button class="action-btn" style="background:transparent; border: 1px dashed #444" id="btn-new-user">+ NEW / RECOVER</button>
            <button class="action-btn" style="background:#334155" id="btn-close-user">CANCEL</button>
        </div>

        <div id="new-link-overlay" class="overlay hidden">
            <h3 style="color: var(--accent); letter-spacing: 2px;">CONNECTION</h3>
            <p style="font-size: 0.8rem; opacity: 0.7; margin-bottom: 20px;">ENTER DESIGNATION TO CREATE OR RECOVER</p>
            
            <input type="text" id="new-agent-name" placeholder="AGENT_ID" maxlength="12" autocomplete="off">
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button id="btn-create-link" class="action-btn">INITIALIZE</button>
                <button id="btn-cancel-link" class="action-btn secondary-btn">ABORT</button>
            </div>
        </div>

        <div id="pin-overlay" class="overlay hidden">
            <h3 id="pin-title" style="color: var(--hyper); letter-spacing: 2px;">SECURITY CHECK</h3>
            <p id="pin-reason" class="pin-subtitle">AUTHORIZATION REQUIRED</p>
            
            <input type="password" inputmode="numeric" pattern="[0-9]*" id="pin-input-field" maxlength="4" placeholder="****" autocomplete="off">
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button id="btn-pin-confirm" class="action-btn">AUTHENTICATE</button>
                <button id="btn-pin-cancel" class="action-btn secondary-btn">CANCEL</button>
            </div>
        </div>

    </div>

<script type="module">
    /* ----------------------------------------------------
       NEURO-SPEED ELITE 4.2 [STABILITY PATCH]
       - Fixed: Leaderboard button unresponsiveness
       - Fixed: Event listener execution order
       - Added: Visual touch feedback on Grid button
       - CRITICAL FIX: Score clamping (no drop on correct answer)
       - CRITICAL FIX: Session Zone persistence (streak saving)
       ----------------------------------------------------
    */

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, doc, setDoc, query, orderBy, limit, getDocs, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBbUKJ9FgkTMU2WHM4N0uYAujLBDBV-ILs",
      authDomain: "neuro-speed-web.firebaseapp.com",
      projectId: "neuro-speed-web",
      storageBucket: "neuro-speed-web.firebasestorage.app",
      messagingSenderId: "314397349425",
      appId: "1:314397349425:web:992853535b9f8bd61de710"
    };

    (function() {
        // --- 1. INITIALIZATION & VARIABLES ---
        window.gameScore = 0;
        let honeyPotTriggered = false;
        Object.defineProperty(window, 'gameScore', {
            get: () => 0, set: (val) => { console.warn("Unauthorized memory access."); honeyPotTriggered = true; }
        });

        let db;
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            console.log("Neuro-Link Secured.");
        } catch(e) { console.error("Link Error:", e); }

        const SALT = "NEURO_SECURE_SALT_9283"; 
        let appData = { users: {}, currentUser: null };
        let clickHistory = [];
        let pinResolver = null; 
        let realtimeUnsubscribe = null;

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const isTouch = ('ontouchstart' in window || navigator.maxTouchPoints > 0) && window.innerWidth < 1024;

        // Game Config
        const SHAPES = ['circle', 'square', 'triangle', 'diamond', 'cross'];
        const L2_COLORS = ['#22d3ee', '#4ade80', '#f472b6', '#fbbf24'];
        const QUESTION_TIMEOUT_MS = 15000;
        let questionTimerStart = 0;
        let isTimedOut = false;
        let lastTickTime = 0; 

        // Directions
        const DIR_MAP = [
            { id: 0, key: 6, label: '6', angle: 0 },            
            { id: 1, key: 3, label: '3', angle: Math.PI*0.25 },
            { id: 2, key: 2, label: '2', angle: Math.PI*0.5 }, 
            { id: 3, key: 1, label: '1', angle: Math.PI*0.75 },
            { id: 4, key: 4, label: '4', angle: Math.PI },        
            { id: 5, key: 7, label: '7', angle: Math.PI*1.25 },
            { id: 6, key: 8, label: '8', angle: Math.PI*1.5 }, 
            { id: 7, key: 9, label: '9', angle: Math.PI*1.75 } 
        ];

        // State
        let state = 'IDLE', currentTask = null, selectionBoxes = [];
        let centerX, centerY, minDim;
        let targetShape, satShape, satColorIdx, satDirIdx;
        let uShape, uSat, uColor, uDir;
        let sessionZone = 0;
        let activeDistractors = [], lastFlashRadius = 0;
        let inputLocked = false, lastSelectionIndex = -1, ripples = [];
        let animFrameId;

        // --- 2. AUDIO SYSTEM ---
        const AudioSys = {
            ctx: null, enabled: false,
            init: function() {
                if (!this.ctx) {
                    const AudioContext = window.AudioContext || window.webkitAudioContext;
                    if(AudioContext) this.ctx = new AudioContext();
                }
                if (this.ctx && this.ctx.state === 'suspended') this.ctx.resume();
            },
            playTone: function(freq, type, duration, vol=0.1, slideTo=null) {
                if (!this.enabled || !this.ctx) return;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = type;
                osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
                if (slideTo) osc.frequency.exponentialRampToValueAtTime(slideTo, this.ctx.currentTime + duration);
                gain.gain.setValueAtTime(vol, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + duration);
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                osc.start();
                osc.stop(this.ctx.currentTime + duration);
            },
            playUI: function(type) {
                if(!this.enabled) return;
                if(type === 'click') this.playTone(800, 'sine', 0.1, 0.05);
                if(type === 'lock') this.playTone(1200, 'triangle', 0.1, 0.05, 600);
            },
            playGame: function(type) {
                if(!this.enabled) return;
                if (type === 'flash') this.playTone(200, 'triangle', 0.15, 0.1, 800);
                else if (type === 'success') {
                    const root = 440 * (1 + (sessionZone * 0.05));
                    this.playTone(root, 'sine', 0.3, 0.1);
                    setTimeout(() => this.playTone(root * 1.25, 'sine', 0.3, 0.08), 50);
                    setTimeout(() => this.playTone(root * 1.5, 'sine', 0.4, 0.06), 100);
                } else if (type === 'fail') {
                    this.playTone(150, 'sawtooth', 0.4, 0.15, 50);
                    this.playTone(140, 'sawtooth', 0.4, 0.15, 40);
                } else if (type === 'levelUp') {
                    this.playTone(440, 'square', 0.1, 0.1);
                    setTimeout(() => this.playTone(880, 'square', 0.1, 0.1), 100);
                    setTimeout(() => this.playTone(1760, 'square', 0.4, 0.1), 200);
                } else if (type === 'timer') this.playTone(800, 'square', 0.05, 0.02);
            },
            toggle: function() {
                this.enabled = !this.enabled;
                if(this.enabled) this.init();
                return this.enabled;
            }
        };

        // --- 3. HELPER FUNCTIONS ---
        function generateHash(data) {
            const str = JSON.stringify(data) + SALT;
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return hash.toString();
        }

        function save() {
            if (honeyPotTriggered) return;
            const hash = generateHash(appData);
            localStorage.setItem('neuroElite_v3_secure', JSON.stringify(appData));
            localStorage.setItem('neuroElite_sig', hash);
        }

        function hideOverlays() { document.querySelectorAll('.overlay').forEach(o => o.classList.add('hidden')); }

        function triggerSystemMessage(text, type) {
            const el = document.getElementById('system-message');
            el.innerText = text; el.className = ''; 
            if(type === 'upgrade') { el.classList.add('sys-upgrade'); AudioSys.playGame('levelUp'); }
            else if(type === 'info') el.classList.add('sys-info');
            else el.classList.add('sys-alert');
            requestAnimationFrame(() => el.classList.remove('hidden'));
            setTimeout(() => el.classList.add('hidden'), 3500);
        }

        // --- 4. CORE LOGIC ---
        function requestPin(title, reason) {
            return new Promise((resolve) => {
                hideOverlays();
                const overlay = document.getElementById('pin-overlay');
                const input = document.getElementById('pin-input-field');
                document.getElementById('pin-title').innerText = title || "SECURITY CHECK";
                document.getElementById('pin-reason').innerText = reason || "ENTER KEY";
                input.value = "";
                overlay.classList.remove('hidden');
                setTimeout(() => input.focus(), 100);
                pinResolver = resolve;
            });
        }

        function initRealtimeSync(userId) {
            if (realtimeUnsubscribe) realtimeUnsubscribe();
            if (!db || !userId) return;
            console.log(`Stream: ${userId}`);
            realtimeUnsubscribe = onSnapshot(doc(db, "leaderboard", userId), (docSnap) => {
                if (docSnap.exists()) {
                    if (docSnap.metadata.hasPendingWrites) return;
                    const cloudData = docSnap.data();
                    const u = appData.users[userId];
                    if (state === 'IDLE' && u) {
                        if (cloudData.score !== u.score || cloudData.speed !== u.speed) {
                            u.score = cloudData.score || 0;
                            u.speed = cloudData.speed;
                            u.level2 = (u.speed <= 400);
                            u.level3 = (u.speed <= 300);
                            if(cloudData.pin && u.pin !== cloudData.pin) u.pin = cloudData.pin;
                            
                            // Try to sync sessionZone from cloud if available, though typically local
                            if(cloudData.sessionZone !== undefined) {
                                u.sessionZone = cloudData.sessionZone;
                                sessionZone = u.sessionZone;
                            }

                            save(); updateUI();
                            triggerSystemMessage("REMOTE SYNC DETECTED", "info");
                            const ind = document.getElementById('sync-indicator');
                            ind.classList.add('syncing'); setTimeout(() => ind.classList.remove('syncing'), 1000);
                        }
                    }
                }
            });
        }

        function updateUI() {
            const u = appData.users[appData.currentUser];
            if(!u) return;
            if (!u.peakScore) u.peakScore = 0;
            if (u.score > u.peakScore) u.peakScore = u.score;
            document.getElementById('user-display').innerText = appData.currentUser;
            const currentDisplay = Math.floor(u.score || 0);
            document.getElementById('score-val').innerText = currentDisplay.toLocaleString();
            const scoreEl = document.getElementById('score-val');
            if (currentDisplay < u.peakScore * 0.5) scoreEl.style.color = 'var(--fail)';
            else if (currentDisplay > u.peakScore * 0.9) scoreEl.style.color = 'var(--success)';
            else scoreEl.style.color = 'var(--gold)';
            document.getElementById('speed-val').innerText = Math.round(u.speed) + 'ms';
            document.getElementById('daily-streak-badge').innerText = `üî• ${u.dailyStreak || 0}`;
            document.getElementById('mode-indicator').innerText = u.level3 ? "T3" : (u.level2 ? "T2" : "T1");
            const fill = document.getElementById('zone-fill');
            const label = document.getElementById('zone-label');
            const percentage = Math.min(sessionZone * 10, 100);
            fill.style.width = percentage + "%";
            if (sessionZone >= 10) {
                fill.style.background = "linear-gradient(90deg, #f59e0b, #ef4444)"; fill.classList.add('zone-gold');
                label.innerText = "SINGULARITY: MAX"; canvas.classList.add('singularity-glow');
            } else if (sessionZone >= 5) {
                fill.style.background = "linear-gradient(90deg, #a855f7, #ec4899)"; fill.classList.add('zone-gold');
                label.innerText = "OVERCLOCK: ACTIVE"; canvas.classList.remove('singularity-glow');
            } else {
                fill.style.background = "linear-gradient(90deg, var(--accent), #38bdf8)"; fill.classList.remove('zone-gold');
                label.innerText = `SYNC STREAK: ${sessionZone}`; canvas.classList.remove('singularity-glow');
            }
        }

        function backgroundSync() {
            if (!appData.currentUser || honeyPotTriggered || appData.users[appData.currentUser].speed < 100) return Promise.resolve();
            const u = appData.users[appData.currentUser];
            const ind = document.getElementById('sync-indicator'); 
            ind.classList.add('syncing');
            const total = u.resultsHistory.length;
            const correct = u.resultsHistory.filter(r => r.correct).length;
            const accuracy = total > 0 ? Math.round((correct / total) * 100) : 0;
            return setDoc(doc(db, "leaderboard", appData.currentUser), {
                name: appData.currentUser, score: Math.floor(u.score), speed: Math.round(u.speed), 
                accuracy: accuracy, tier: u.level3 ? "T3" : (u.level2 ? "T2" : "T1"), 
                timestamp: new Date(), pin: u.pin || null,
                sessionZone: u.sessionZone || 0 // Sync streak state
            }, { merge: true })
            .then(() => setTimeout(() => ind.classList.remove('syncing'), 500))
            .catch((e) => { console.log("Bg Sync Fail", e); ind.classList.remove('syncing'); });
        }

        function checkDailyStreak() {
            const u = appData.users[appData.currentUser];
            const today = new Date().toISOString().split('T')[0];
            if (!u.lastPlayDate) { u.lastPlayDate = today; u.dailyStreak = 1; }
            else if (u.lastPlayDate !== today) {
                const diff = (new Date(today) - new Date(u.lastPlayDate)) / 86400000;
                if (diff >= 0.9 && diff < 2) u.dailyStreak++; else if (diff >= 2) u.dailyStreak = 1;
                u.lastPlayDate = today;
            }
            save();
        }

        // --- 5. GAME LOOP FUNCTIONS ---
        function drawShape(type, x, y, size, color) {
            ctx.beginPath(); ctx.fillStyle = color;
            if (type === 'circle') ctx.arc(x, y, size, 0, Math.PI * 2);
            else if (type === 'square') ctx.rect(x - size, y - size, size * 2, size * 2);
            else if (type === 'triangle') { ctx.moveTo(x, y - size); ctx.lineTo(x + size, y + size); ctx.lineTo(x - size, y + size); ctx.closePath(); }
            else if (type === 'diamond') { ctx.moveTo(x, y - size * 1.2); ctx.lineTo(x + size * 1.2, y); ctx.lineTo(x, y + size * 1.2); ctx.lineTo(x - size * 1.2, y); ctx.closePath(); }
            else if (type === 'cross') { ctx.rect(x - size/3, y - size, size/1.5, size * 2); ctx.rect(x - size, y - size/3, size * 2, size/1.5); }
            ctx.fill();
        }

        function executeFlash() {
            if (state !== 'IDLE') return;
            document.getElementById('sync-vis-container').style.opacity = '0'; 
            state = 'FLASHING'; isTimedOut = false;
            const u = appData.users[appData.currentUser];
            targetShape = SHAPES[Math.floor(Math.random() * SHAPES.length)];
            satShape = SHAPES[Math.floor(Math.random() * SHAPES.length)];
            satColorIdx = u.level2 ? Math.floor(Math.random() * L2_COLORS.length) : -1;
            satDirIdx = Math.floor(Math.random() * 8); 
            lastFlashRadius = minDim * 0.35;
            const angle = u.level3 ? DIR_MAP[satDirIdx].angle : Math.random() * Math.PI * 2;
            const satX = centerX + Math.cos(angle) * lastFlashRadius; 
            const satY = centerY + Math.sin(angle) * lastFlashRadius;
            activeDistractors = [];
            const count = 12; const step = (Math.PI * 2) / count;
            for (let i = 0; i < count; i++) {
                const a = i * step;
                if (Math.abs(Math.atan2(Math.sin(a - angle), Math.cos(a - angle))) > 0.6) {
                    activeDistractors.push({
                        x: centerX + Math.cos(a) * lastFlashRadius + (Math.random()-0.5)*20,
                        y: centerY + Math.sin(a) * lastFlashRadius + (Math.random()-0.5)*20,
                        shape: SHAPES[Math.floor(Math.random() * SHAPES.length)]
                    });
                }
            }
            AudioSys.playGame('flash'); 
            let startTime = null;
            function animate(now) {
                if (!startTime) startTime = now;
                const elapsed = now - startTime;
                if (elapsed < u.speed) {
                    ctx.clearRect(0,0,canvas.width,canvas.height);
                    activeDistractors.forEach(d => drawShape(d.shape, d.x, d.y, minDim * 0.05, '#334155'));
                    drawShape(targetShape, centerX, centerY, minDim * 0.06, '#fff');
                    drawShape(satShape, satX, satY, minDim * 0.05, u.level2 ? L2_COLORS[satColorIdx] : '#8b5cf6');
                    animFrameId = requestAnimationFrame(animate);
                } else if (elapsed < u.speed + 100) {
                    ctx.fillStyle = "#000"; ctx.fillRect(0,0,canvas.width, canvas.height);
                    animFrameId = requestAnimationFrame(animate);
                } else { state = 'QUESTIONING'; inputLocked = false; startQuestionLoop(); }
            }
            animFrameId = requestAnimationFrame(animate);
        }

        function startQuestionLoop() {
            askTask('CENTER', SHAPES);
            function loop(now) {
                if (state === 'QUESTIONING') {
                    if (!questionTimerStart) questionTimerStart = now;
                    const elapsed = now - questionTimerStart;
                    const remaining = QUESTION_TIMEOUT_MS - elapsed;
                    if (remaining <= 0) {
                        if(!isTimedOut) { isTimedOut = true; triggerSystemMessage("NEURAL LINK SEVERED (TIMEOUT)", "alert"); uShape = null; finalizeTrial(); }
                        return; 
                    }
                    if (remaining < 5000) {
                        if (now - lastTickTime > 1000) { AudioSys.playGame('timer'); lastTickTime = now; }
                    }
                    ctx.fillStyle = '#020617'; ctx.fillRect(0,0,canvas.width,canvas.height);
                    const timePct = Math.max(0, remaining / QUESTION_TIMEOUT_MS);
                    const barColor = timePct < 0.2 ? '#ef4444' : (timePct < 0.5 ? '#f59e0b' : '#0ea5e9');
                    ctx.fillStyle = 'rgba(255,255,255,0.1)'; ctx.fillRect(0, 0, canvas.width, 6); 
                    ctx.fillStyle = barColor; ctx.shadowColor = barColor; ctx.shadowBlur = 10;
                    ctx.fillRect(0, 0, canvas.width * timePct, 6); ctx.shadowBlur = 0;
                    if (timePct < 0.3) {
                        ctx.fillStyle = "#ef4444"; ctx.font = `bold ${minDim * 0.03}px monospace`;
                        ctx.textAlign = "right"; ctx.fillText((remaining/1000).toFixed(1) + "s", canvas.width - 10, 25);
                    }
                    let title = "", sub = "";
                    if(currentTask === 'CENTER') { title = "CORE ID"; sub = "SELECT CENTER SHAPE"; }
                    else if(currentTask === 'SATELLITE') { title = "PERIPHERAL ID"; sub = "SELECT SATELLITE SHAPE"; }
                    else if(currentTask === 'COLOR') { title = "SPECTRUM ID"; sub = "MATCH SATELLITE COLOR"; }
                    else { title = "VECTOR ID"; sub = "INDICATE ORIGIN"; }
                    ctx.textAlign = "center"; ctx.fillStyle = "#fff";
                    ctx.font = `900 ${minDim * 0.07}px 'Inter', system-ui`; ctx.fillText(title, centerX, centerY - minDim * 0.15);
                    ctx.fillStyle = "#0ea5e9"; ctx.font = `700 ${minDim * 0.03}px monospace`; ctx.fillText(sub, centerX, centerY - minDim * 0.08);
                    selectionBoxes = [];
                    if (currentTask === 'DIRECTION') {
                        const layoutRadius = minDim * 0.3; const btnSize = minDim * 0.07;
                        DIR_MAP.forEach(dir => {
                            const x = centerX + Math.cos(dir.angle) * layoutRadius;
                            const y = centerY + Math.sin(dir.angle) * layoutRadius;
                            const isSelected = (dir.id === lastSelectionIndex);
                            ctx.beginPath();
                            if (isSelected) { ctx.shadowBlur = 20; ctx.shadowColor = "rgba(14, 165, 233, 0.8)"; ctx.fillStyle = "rgba(14, 165, 233, 0.4)"; } 
                            else { ctx.shadowBlur = 0; ctx.fillStyle = "rgba(255, 255, 255, 0.05)"; }
                            ctx.strokeStyle = isSelected ? "var(--accent)" : "#334155"; ctx.lineWidth = 3;
                            ctx.arc(x, y, btnSize, 0, Math.PI * 2); ctx.fill(); ctx.stroke(); ctx.shadowBlur = 0;
                            ctx.fillStyle = isSelected ? "#fff" : "#64748b"; ctx.font = `800 ${minDim * 0.05}px monospace`;
                            ctx.textBaseline = "middle"; ctx.fillText(dir.label, x, y); ctx.textBaseline = "alphabetic";
                            selectionBoxes.push({ key: dir.key, val: dir.id, x1: x - btnSize, x2: x + btnSize, y1: y - btnSize, y2: y + btnSize, cx: x, cy: y });
                        });
                    } else {
                        const items = currentTask === 'CENTER' ? SHAPES : (currentTask === 'SATELLITE' ? SHAPES : L2_COLORS);        
                        const rowWidth = canvas.width * 0.85; const spacing = rowWidth / (items.length - 1); const startX = (canvas.width - rowWidth) / 2;
                        items.forEach((item, i) => {
                            const x = startX + (i * spacing), y = centerY + 60;
                            const isSelected = (i === lastSelectionIndex);
                            if (isSelected) { ctx.save(); ctx.shadowBlur = 20; ctx.shadowColor = "rgba(14, 165, 233, 0.8)"; ctx.fillStyle = "rgba(14, 165, 233, 0.2)"; ctx.beginPath(); ctx.arc(x, y, minDim * 0.08, 0, Math.PI*2); ctx.fill(); ctx.restore(); }
                            if (currentTask === 'COLOR') { ctx.fillStyle = item; ctx.beginPath(); ctx.arc(x, y, minDim * 0.06, 0, Math.PI*2); ctx.fill(); }
                            else { drawShape(item, x, y, minDim * 0.05, '#fff'); }
                            if (!isTouch) {
                                ctx.fillStyle = isSelected ? "var(--accent)" : "rgba(255, 255, 255, 0.3)";
                                ctx.font = `bold ${minDim * 0.02}px monospace`; ctx.fillText(`[${i + 1}]`, x, y + minDim * 0.15); 
                            }
                            selectionBoxes.push({ key: item, val: i, x1: x - spacing/2, x2: x + spacing/2, y1: y - 100, y2: y + 100, cx: x, cy: y });
                        });
                    }
                    for (let i = ripples.length - 1; i >= 0; i--) {
                        const r = ripples[i]; r.radius += 5; r.opacity -= 0.05;
                        ctx.beginPath(); ctx.arc(r.x, r.y, r.radius, 0, Math.PI * 2); ctx.strokeStyle = `rgba(255, 255, 255, ${r.opacity})`; ctx.stroke();
                        if (r.opacity <= 0) ripples.splice(i, 1);
                    }
                    animFrameId = requestAnimationFrame(loop);
                }
            }
            animFrameId = requestAnimationFrame(loop);
        }

        function askTask(type, items) { currentTask = type; questionTimerStart = 0; }
        
        function processHit(hit) {
            lastSelectionIndex = hit.val; inputLocked = true; AudioSys.playUI('lock');
            setTimeout(() => { 
                inputLocked = false; lastSelectionIndex = -1;
                const u = appData.users[appData.currentUser];
                if (currentTask === 'CENTER') { uShape = hit.key; askTask('SATELLITE', SHAPES); }
                else if (currentTask === 'SATELLITE') {
                    uSat = hit.key;
                    if (u.level2) askTask('COLOR', L2_COLORS); else if (u.level3) askTask('DIRECTION', null); else finalizeTrial();
                } 
                else if (currentTask === 'COLOR') { uColor = hit.val; if (u.level3) askTask('DIRECTION', null); else finalizeTrial(); }
                else if (currentTask === 'DIRECTION') { uDir = hit.val; finalizeTrial(); }
            }, 320);
        }

        async function finalizeTrial() {
            if (honeyPotTriggered) { appData.users[appData.currentUser].score = 0; location.reload(); return; }
            const u = appData.users[appData.currentUser];
            let correct = (uShape === targetShape && uSat === satShape);
            if (u.level2 && uColor !== satColorIdx) correct = false;
            if (u.level3 && uDir !== satDirIdx) correct = false;
            if (isTimedOut) correct = false;
            state = 'IDLE'; cancelAnimationFrame(animFrameId);
            const prevSpeed = u.speed;
            
            if (correct) {
                sessionZone++; AudioSys.playGame('success');
                let performanceVal = Math.max(100, (1500 - u.speed)); 
                let tierMult = u.level3 ? 2.5 : (u.level2 ? 1.5 : 1.0);
                let zoneMult = sessionZone > 10 ? 1.5 : (sessionZone > 5 ? 1.2 : 1.0);
                let roundTarget = performanceVal * tierMult * zoneMult * 10;
                
                // --- FIX: Clamp score delta so correct answers never reduce score ---
                let delta = (roundTarget - (u.score || 0)) * 0.15;
                if (delta < 0) delta = 0; // Prevent score drop on correct answer
                u.score = (u.score || 0) + delta;
                
                // --- FIX: Save session streak state ---
                u.sessionZone = sessionZone;

                u.streak = Math.max(0, u.streak) + 1;
                if (u.streak >= 3) { 
                    u.speed = Math.max(16, u.speed * 0.92); u.streak = 0; 
                    if (!u.level2 && u.speed <= 350) { u.level2 = true; u.speed = 400; triggerSystemMessage("TIER 2 UNLOCKED", 'upgrade'); }
                    else if (u.level2 && !u.level3 && u.speed <= 220) { u.level3 = true; u.speed = 300; triggerSystemMessage("TIER 3 UNLOCKED", 'upgrade'); }
                }
                document.getElementById('msg-title').innerText = "SYNC STABLE";
                document.getElementById('msg-title').style.color = "#10b981";
                document.getElementById('msg-body').innerText = `RATING: ${Math.floor(u.score)}`;
            } else {
                sessionZone = 0; 
                u.sessionZone = 0; // Reset saved state on failure
                AudioSys.playGame('fail');
                let penalty = u.score * 0.20; u.score = Math.max(0, u.score - penalty); 
                u.streak = Math.min(0, u.streak) - 1; u.speed = Math.min(1000, u.speed + 80); 
                document.getElementById('msg-title').innerText = isTimedOut ? "SYNC TIMEOUT" : "SYNC LOST";
                document.getElementById('msg-title').style.color = "#ef4444";
                document.getElementById('msg-body').innerText = `RATING DROP: -${Math.floor(penalty)}`;
                if (u.streak <= -3 && (u.level2 || u.level3)) {
                    if (u.level3) { u.level3 = false; triggerSystemMessage("TIER 3 REVOKED", 'alert'); }
                    else { u.level2 = false; triggerSystemMessage("TIER 2 REVOKED", 'alert'); }
                    u.streak = 0; u.speed += 100;
                }
            }
            const maxLatency = 1000;
            const oldPct = Math.max(0, Math.min(100, ((maxLatency - prevSpeed) / maxLatency) * 100));
            const newPct = Math.max(0, Math.min(100, ((maxLatency - u.speed) / maxLatency) * 100));
            const barVis = document.getElementById('sync-vis-container');
            const barFill = document.getElementById('sync-bar-fill');
            const pctText = document.getElementById('sync-percentage');
            barVis.style.opacity = '1';
            const themeColor = correct ? 'var(--success)' : 'var(--fail)';
            barFill.style.background = themeColor; barFill.style.boxShadow = `0 0 15px ${themeColor}`; pctText.style.color = themeColor;
            barFill.style.transition = 'none'; barFill.style.width = `${oldPct}%`; pctText.innerText = `${Math.round(oldPct)}%`;
            setTimeout(() => { barFill.style.transition = 'width 0.6s cubic-bezier(0.22, 1, 0.36, 1)'; barFill.style.width = `${newPct}%`; pctText.innerText = `${Math.round(newPct)}%`; }, 50);
            u.history.push(Math.round(u.speed));
            u.resultsHistory.push({ correct, date: new Date().toISOString().split('T')[0] });
            save(); updateUI();
            
            const startBtn = document.getElementById('start-btn');
            const lbBtn = document.getElementById('btn-lb-main');
            startBtn.classList.add('locked-btn');
            const oldLbText = lbBtn.innerText;
            lbBtn.innerText = "SAVING DATA..."; lbBtn.classList.add('locked-btn');
            document.getElementById('main-overlay').classList.remove('hidden');
            await backgroundSync();
            setTimeout(() => startBtn.classList.remove('locked-btn'), 600);
            lbBtn.classList.remove('locked-btn'); lbBtn.innerText = oldLbText;
        }

        // --- 6. OVERLAY FUNCTIONS (MUST BE DEFINED BEFORE LISTENERS) ---
        async function showLeaderboard() {
            AudioSys.playUI('click');
            console.log("Opening Leaderboard...");
            hideOverlays(); document.getElementById('leaderboard-overlay').classList.remove('hidden');
            const list = document.getElementById('lb-list'); list.innerHTML = "";
            document.getElementById('lb-loading').style.display = 'block';
            try {
                const q = query(collection(db, "leaderboard"), orderBy("score", "desc"), limit(20));
                const querySnapshot = await getDocs(q);
                document.getElementById('lb-loading').style.display = 'none';
                let rank = 1;
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    const acc = data.accuracy !== undefined ? data.accuracy + "%" : "--";
                    const isSecure = data.pin ? "üîí" : "";
                    const row = document.createElement('div'); row.className = 'lb-row';
                    row.innerHTML = `<div class="lb-rank">${rank++}</div><div class="lb-name"><span class="lb-tier">${data.tier}</span>${data.name} <span style="font-size:0.7em">${isSecure}</span></div><div class="lb-right"><span class="lb-score">${data.score.toLocaleString()}</span><div class="lb-sub"><span class="lb-stat peak">‚ö°${data.speed}ms</span><span class="lb-stat acc">üéØ${acc}</span></div></div>`;
                    list.appendChild(row);
                });
                if (querySnapshot.empty) list.innerHTML = "<div style='opacity:0.5; margin-top:20px'>NO DATA ON THE GRID</div>";
            } catch (e) { console.error(e); document.getElementById('lb-loading').innerText = "CONNECTION FAILURE"; }
        }

        function showAnalytics() {
            AudioSys.playUI('click');
            hideOverlays(); document.getElementById('analytics-overlay').classList.remove('hidden');
            const u = appData.users[appData.currentUser];
            const cv = document.getElementById('chart-canvas'), cx = cv.getContext('2d');
            cv.width = cv.offsetWidth * 2; cv.height = cv.offsetHeight * 2;
            cx.strokeStyle = "#0ea5e9"; cx.lineWidth = 4; cx.beginPath();
            const data = u.history.slice(-30);
            data.forEach((v, i) => {
                const x = (i / (data.length - 1 || 1)) * cv.width;
                const y = cv.height - (v / 1000 * cv.height);
                if (i === 0) cx.moveTo(x,y); else cx.lineTo(x,y);
            });
            cx.stroke();
            const acc = Math.round((u.resultsHistory.filter(r => r.correct).length / u.resultsHistory.length * 100)) || 0;
            document.getElementById('stat-peak').innerText = `${Math.min(...u.history)}ms`;
            document.getElementById('stat-acc-total').innerText = `${acc}%`;
            document.getElementById('stat-uptime').innerText = (u.totalTimeMs / 3600000).toFixed(1) + 'h';
            document.getElementById('stat-grade').innerText = acc > 90 ? "S" : (acc > 75 ? "A" : "B");

            const actionContainer = document.getElementById('analytics-actions');
            actionContainer.innerHTML = ''; 
            if (!u.pin) {
                const btn = document.createElement('button');
                btn.className = 'action-btn'; btn.style.background = '#0f172a'; btn.style.border = '1px solid var(--accent)';
                btn.style.fontSize = '0.75rem'; btn.innerText = "üîí LOCK PROTOCOL (SET PIN)";
                btn.onclick = async () => {
                    const newPin = await requestPin("SECURE AGENT", "SET 4-DIGIT PIN");
                    if (newPin && newPin.length === 4) {
                        u.pin = newPin; save(); backgroundSync(); triggerSystemMessage("PROTOCOL SECURED", "upgrade"); showAnalytics(); 
                    } else if (newPin !== null) { alert("INVALID LENGTH"); showAnalytics(); } else { showAnalytics(); }
                };
                actionContainer.appendChild(btn);
            } else {
                 const lbl = document.createElement('div'); lbl.innerText = "PROTOCOL SECURED üîí";
                 lbl.style.color = "#94a3b8"; lbl.style.fontSize = "0.7rem"; lbl.style.marginTop = "10px";
                 actionContainer.appendChild(lbl);
            }
            const dangerContainer = document.getElementById('analytics-danger-zone');
            dangerContainer.innerHTML = '';
            const unlinkBtn = document.createElement('button');
            unlinkBtn.className = 'action-btn danger-btn'; unlinkBtn.innerText = "SEVER CONNECTION (UNLINK)";
            unlinkBtn.style.fontSize = '0.75rem';
            unlinkBtn.onclick = () => {
                if(confirm("WARNING: THIS WILL REMOVE THIS AGENT FROM THIS DEVICE.\n\nData will remain on the Grid (Cloud) if synced.\nYou can relink later using the PIN.")) {
                    if(realtimeUnsubscribe) { realtimeUnsubscribe(); realtimeUnsubscribe = null; }
                    delete appData.users[appData.currentUser]; appData.currentUser = null;
                    save(); location.reload(); 
                }
            };
            dangerContainer.appendChild(unlinkBtn);
        }

        function showUserMenu() {
            AudioSys.playUI('click');
            if(realtimeUnsubscribe) { realtimeUnsubscribe(); realtimeUnsubscribe = null; }
            hideOverlays(); document.getElementById('user-overlay').classList.remove('hidden');
            const list = document.getElementById('user-list'); list.innerHTML = '';
            Object.keys(appData.users).forEach(name => {
                const btn = document.createElement('div'); btn.className = 'a-card';
                btn.style.marginBottom = '8px'; btn.style.cursor = 'pointer';
                const s = appData.users[name].score ? Math.floor(appData.users[name].score) : 0;
                btn.innerHTML = `<span class="l">${name}</span><span class="v" style="color:var(--gold)">${s} Rating</span>`;
                btn.onclick = () => { 
                    appData.currentUser = name; 
                    // --- FIX: RESTORE SAVED SESSION ZONE ---
                    sessionZone = appData.users[name].sessionZone || 0; 
                    
                    checkDailyStreak(); updateUI(); hideOverlays(); 
                    document.getElementById('main-overlay').classList.remove('hidden');
                    initRealtimeSync(name);
                };
                list.appendChild(btn);
            });
        }

        async function handleNewLinkAttempt() {
            const input = document.getElementById('new-agent-name');
            const btn = document.getElementById('btn-create-link');
            const n = input.value.trim().toUpperCase();
            if (!n || n.length === 0) return;
            if (appData.users[n]) { alert("DESIGNATION ALREADY ACTIVE ON DEVICE."); return; }
            btn.innerText = "SCANNING GRID...";
            try {
                const docRef = doc(db, "leaderboard", n);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const cloudData = docSnap.data();
                    let authenticated = false;
                    if (cloudData.pin) {
                        const enteredPin = await requestPin("RECOVERY MODE", `AGENT ${n} DETECTED. ENTER KEY.`);
                        if (enteredPin === cloudData.pin) authenticated = true;
                        else if (enteredPin !== null) alert("INVALID KEY. RECOVERY ABORTED.");
                    } else authenticated = true; 
                    if (authenticated) {
                        appData.users[n] = { 
                            speed: cloudData.speed || 450, score: cloudData.score || 0, peakScore: cloudData.score || 0, 
                            streak: 0, history: [cloudData.speed || 450], resultsHistory: [], 
                            level2: cloudData.tier === 'T2' || cloudData.tier === 'T3', level3: cloudData.tier === 'T3', 
                            totalTimeMs: 0, dailyStreak: 0, lastPlayDate: null, pin: cloudData.pin,
                            sessionZone: cloudData.sessionZone || 0 // Restore state from cloud if possible
                        };
                        appData.currentUser = n; 
                        sessionZone = appData.users[n].sessionZone; 
                        save(); updateUI(); hideOverlays();
                        document.getElementById('main-overlay').classList.remove('hidden');
                        triggerSystemMessage("NEURAL LINK RESTORED", "upgrade");
                        initRealtimeSync(n); return; 
                    } else { btn.innerText = "INITIALIZE"; return; }
                }
            } catch (e) { console.error("Grid Scan Error", e); }
            let pin = await requestPin("SECURE NEW LINK", "SET OPTIONAL 4-DIGIT PIN (OR LEAVE BLANK)");
            if (pin === "") pin = null;
            appData.users[n] = { 
                speed: 450, score: 0, peakScore: 0, streak: 0, history: [450], resultsHistory: [], 
                level2: false, level3: false, totalTimeMs: 0, dailyStreak: 0, lastPlayDate: null, pin: pin,
                sessionZone: 0 // Initialize streak
            };
            appData.currentUser = n; sessionZone = 0; save(); updateUI(); hideOverlays(); 
            document.getElementById('main-overlay').classList.remove('hidden');
            initRealtimeSync(n); backgroundSync();
        }

        function load() {
            const saved = localStorage.getItem('neuroElite_v3_secure');
            const sig = localStorage.getItem('neuroElite_sig');
            if (saved && sig) {
                const check = generateHash(JSON.parse(saved));
                if (check === sig) { appData = JSON.parse(saved); } 
                else { localStorage.clear(); appData = { users: {}, currentUser: null }; }
            }
            if (appData.currentUser) { 
                // --- FIX: Restore session zone on auto-load ---
                sessionZone = appData.users[appData.currentUser].sessionZone || 0;
                checkDailyStreak(); updateUI(); initRealtimeSync(appData.currentUser); 
            } 
            else showUserMenu();
        }

        function resize() { 
            canvas.width = window.innerWidth; canvas.height = window.innerHeight - 96; 
            centerX = canvas.width / 2; centerY = canvas.height / 2; minDim = Math.min(canvas.width, canvas.height); 
        }

        function handleInput(e) {
            if (state !== 'QUESTIONING' || inputLocked) return;
            const rect = canvas.getBoundingClientRect();
            const clientX = e.clientX || (e.touches && e.touches.length > 0 ? e.touches[0].clientX : 0);
            const clientY = e.clientY || (e.touches && e.touches.length > 0 ? e.touches[0].clientY : 0);
            const x = clientX - rect.left; const y = clientY - rect.top;
            ripples.push({ x: x, y: y, radius: 0, opacity: 1 });
            const hit = selectionBoxes.find(b => x > b.x1 && x < b.x2 && y > b.y1 && y < b.y2);
            if (!hit) return;
            const dist = Math.sqrt(Math.pow(hit.cx - x, 2) + Math.pow(hit.cy - y, 2));
            clickHistory.push(dist); if (clickHistory.length > 10) clickHistory.shift();
            const variance = clickHistory.reduce((a, b) => a + b, 0) / clickHistory.length;
            if (clickHistory.length >= 5 && variance < 2.0) { console.warn("Automated input detected."); honeyPotTriggered = true; }
            processHit(hit);
        }

        // --- 7. EVENT LISTENERS (ASSIGNED LAST) ---
        document.getElementById('start-btn').onclick = () => { AudioSys.init(); AudioSys.playUI('click'); hideOverlays(); setTimeout(executeFlash, 300); };
        
        document.getElementById('btn-audio').onclick = () => {
             const enabled = AudioSys.toggle();
             const btn = document.getElementById('btn-audio');
             const lbl = document.getElementById('audio-icon');
             if(enabled) { btn.classList.add('active'); lbl.innerText = "ON"; AudioSys.playUI('click'); } 
             else { btn.classList.remove('active'); lbl.innerText = "OFF"; }
        };

        // UI Buttons
        document.getElementById('btn-user').onclick = showUserMenu;
        document.getElementById('btn-analytics').onclick = showAnalytics;
        document.getElementById('btn-analytics-2').onclick = showAnalytics;
        
        // Leaderboard - Fixed Assignment
        document.getElementById('btn-leaderboard').onclick = showLeaderboard;
        document.getElementById('btn-lb-main').onclick = showLeaderboard;
        
        // Closers
        document.getElementById('btn-close-analytics').onclick = () => { AudioSys.playUI('click'); hideOverlays(); document.getElementById('main-overlay').classList.remove('hidden'); };
        document.getElementById('btn-close-lb').onclick = () => { AudioSys.playUI('click'); hideOverlays(); document.getElementById('main-overlay').classList.remove('hidden'); };
        document.getElementById('btn-close-user').onclick = () => { AudioSys.playUI('click'); if(appData.currentUser) { hideOverlays(); document.getElementById('main-overlay').classList.remove('hidden'); } };
        
        // Pin & Link Handlers
        document.getElementById('btn-pin-confirm').onclick = () => { if (pinResolver) { pinResolver(document.getElementById('pin-input-field').value); pinResolver = null; } hideOverlays(); };
        document.getElementById('btn-pin-cancel').onclick = () => { if (pinResolver) { pinResolver(null); pinResolver = null; } hideOverlays(); };
        document.getElementById('pin-input-field').addEventListener('keydown', (e) => { if (e.key === 'Enter') document.getElementById('btn-pin-confirm').click(); });
        document.getElementById('btn-new-user').onclick = () => {
             hideOverlays(); const overlay = document.getElementById('new-link-overlay'); const input = document.getElementById('new-agent-name');
             overlay.classList.remove('hidden'); input.value = ''; document.getElementById('btn-create-link').innerText = "INITIALIZE"; setTimeout(() => input.focus(), 100);
        };
        document.getElementById('btn-create-link').onclick = handleNewLinkAttempt;
        document.getElementById('new-agent-name').addEventListener('keydown', (e) => { if (e.key === 'Enter') handleNewLinkAttempt(); });
        document.getElementById('btn-cancel-link').onclick = () => { hideOverlays(); if (appData.currentUser) { document.getElementById('main-overlay').classList.remove('hidden'); } else { showUserMenu(); } };

        // Global Keydown
        window.addEventListener('keydown', (e) => {
            if (state !== 'QUESTIONING' || inputLocked) return;
            if (currentTask === 'DIRECTION') {
                 const keyVal = parseInt(e.key);
                 if (!isNaN(keyVal)) {
                     const hit = selectionBoxes.find(b => b.key === keyVal);
                     if (hit) { ripples.push({ x: hit.cx, y: hit.cy, radius: 0, opacity: 1 }); processHit(hit); return; }
                 }
            }
            const index = parseInt(e.key) - 1;
            if (index >= 0 && index < selectionBoxes.length && currentTask !== 'DIRECTION') {
                const hit = selectionBoxes[index]; ripples.push({ x: hit.cx, y: hit.cy, radius: 0, opacity: 1 }); processHit(hit);
            }
        });

        // Init
        window.addEventListener('resize', resize);
        canvas.addEventListener('mousedown', handleInput);
        canvas.addEventListener('touchstart', (e) => { e.preventDefault(); handleInput(e); }, {passive: false});
        resize(); load();
        setInterval(() => { if (appData.currentUser) appData.users[appData.currentUser].totalTimeMs += 2000; }, 2000);

    })();
</script>
</body>
</html>
