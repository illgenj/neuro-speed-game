<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Neuro-Speed Elite 3.1 [SECURED]</title>
    <style>
        :root { 
            --bg: #020617; --panel: #0f172a; --accent: #0ea5e9; --text: #f8fafc; 
            --success: #10b981; --fail: #ef4444; --gold: #f59e0b; --quantum: #a855f7; 
            --hyper: #f43f5e; --glass: rgba(15, 23, 42, 0.96);
        }
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; user-select: none; }
        
        body { 
            background: var(--bg); color: var(--text); 
            font-family: 'Inter', system-ui, -apple-system, sans-serif; 
            margin: 0; display: flex; flex-direction: column; 
            height: 100vh; overflow: hidden; touch-action: none; 
        }

        /* --- Header & Interactive Stats --- */
        .header { 
            height: 90px; width: 100%; display: flex; align-items: center; 
            background: var(--panel); border-bottom: 2px solid #1e293b; 
            z-index: 50; flex-shrink: 0;
        }
        .stat-group { display: flex; flex-grow: 1; justify-content: space-around; height: 100%; }
        
        .stat { 
            text-align: center; display: flex; flex-direction: column; 
            justify-content: center; padding: 0 5px; cursor: pointer; 
            transition: all 0.2s; min-width: 60px;
        }
        
        .label { font-size: 0.5rem; text-transform: uppercase; opacity: 0.4; letter-spacing: 1.2px; margin-bottom: 2px; font-weight: 700; }
        .val { font-size: 0.85rem; font-weight: 800; color: var(--accent); font-family: monospace; }
        .xp-val { color: var(--gold); }

        /* --- ZONE THERMOMETER --- */
        #zone-container {
            width: 90%; height: 24px; background: #0f172a; 
            margin: 10px auto 5px auto; position: relative; 
            overflow: hidden; border-radius: 12px; border: 2px solid #1e293b;
            box-shadow: inset 0 2px 6px rgba(0,0,0,0.6);
        }
        #zone-fill {
            height: 100%; width: 0%; 
            background: linear-gradient(90deg, var(--accent), #38bdf8);
            transition: width 0.4s cubic-bezier(0.34, 1.56, 0.64, 1), background 0.3s; 
            box-shadow: 0 0 15px var(--accent); position: relative; z-index: 1;
        }
        #zone-fill::after {
            content: ''; position: absolute; top: 0; left: 0; right: 0; height: 50%;
            background: rgba(255,255,255,0.15); border-radius: 12px 12px 0 0;
        }

        #zone-label {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 0.75rem; font-weight: 900; color: #fff; letter-spacing: 2px;
            z-index: 2; text-shadow: 0 1px 3px rgba(0,0,0,0.9); white-space: nowrap;
        }

        @keyframes bar-pulse-gold {
            0% { box-shadow: 0 0 10px var(--gold); }
            50% { box-shadow: 0 0 25px var(--gold), inset 0 0 10px var(--gold); }
            100% { box-shadow: 0 0 10px var(--gold); }
        }
        @keyframes text-pop {
            0% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.4); color: #fff; }
            100% { transform: translate(-50%, -50%) scale(1); }
        }
        
        .zone-gold { animation: bar-pulse-gold 1.5s infinite; }
        .text-pop-anim { animation: text-pop 0.3s ease-out; }

        /* --- Game Area --- */
        #game-container { flex-grow: 1; position: relative; width: 100%; overflow: hidden; }
        canvas { display: block; width: 100%; height: 100%; transition: filter 0.3s; }

        /* --- UI Overlays --- */
        .overlay { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            background: var(--glass); backdrop-filter: blur(20px); padding: 30px; 
            border-radius: 24px; text-align: center; border: 1px solid rgba(255,255,255,0.1); 
            width: 90%; max-width: 400px; z-index: 100; 
            box-shadow: 0 40px 80px -20px rgba(0, 0, 0, 0.9);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            max-height: 80vh; overflow-y: auto;
        }
        .hidden { opacity: 0; pointer-events: none; transform: translate(-50%, -45%) scale(0.95); }
        
        .action-btn { 
            background: var(--accent); color: white; border: none; padding: 18px; 
            font-size: 0.9rem; font-weight: 800; border-radius: 14px; cursor: pointer; 
            width: 100%; margin-top: 10px; transition: all 0.2s;
            text-transform: uppercase; letter-spacing: 1px;
        }
        .action-btn:active { transform: scale(0.97); }
        .secondary-btn { background: #334155; }
        .locked-btn { opacity: 0.5; pointer-events: none; filter: grayscale(1); }

        .analytics-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin: 15px 0; }
        .a-card { background: rgba(0,0,0,0.4); padding: 12px; border-radius: 16px; text-align: left; }
        .a-card .v { display: block; font-weight: 800; color: var(--accent); font-size: 1rem; }
        .a-card .l { font-size: 0.5rem; opacity: 0.4; text-transform: uppercase; font-weight: 700; }

        /* --- LEADERBOARD --- */
        .lb-row { 
            display: flex; align-items: center; padding: 12px 0; 
            border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 0.9rem; 
        }
        .lb-rank { width: 30px; color: var(--gold); font-weight: 900; font-size: 0.8rem; }
        .lb-name { flex-grow: 1; text-align: left; font-weight: 600; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; padding-right: 10px;}
        .lb-tier { font-size: 0.5rem; background: #1e293b; padding: 2px 6px; border-radius: 4px; margin-right: 8px; color: #94a3b8; vertical-align: middle; }
        .lb-right { text-align: right; min-width: 100px; }
        .lb-score { color: var(--accent); font-family: monospace; font-weight: 700; font-size: 1rem; display: block; }
        .lb-sub { font-size: 0.65rem; color: #94a3b8; margin-top: 2px; font-family: monospace;}
        .lb-stat { margin-left: 6px; }
        .lb-stat.peak { color: var(--hyper); }
        .lb-stat.acc { color: var(--success); }
        
        /* Auto-save indicator */
        #sync-indicator {
            position: absolute; top: 15px; left: 15px; width: 8px; height: 8px; 
            background: var(--success); border-radius: 50%; opacity: 0; transition: opacity 0.5s;
            box-shadow: 0 0 10px var(--success); pointer-events: none;
        }
        .syncing { opacity: 1 !important; }

        .singularity-glow { filter: saturate(1.5) contrast(1.1); }

        /* --- SYSTEM MESSAGE HUD --- */
        #system-message {
            position: absolute; top: 120px; left: 50%; transform: translateX(-50%);
            background: rgba(15, 23, 42, 0.95); border: 1px solid #334155;
            padding: 20px 30px; border-radius: 12px; z-index: 200;
            text-align: center; font-weight: 900; letter-spacing: 1px; font-size: 0.9rem;
            box-shadow: 0 10px 40px rgba(0,0,0,0.8); pointer-events: none; 
            transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            width: 85%; max-width: 450px;
        }
        .sys-upgrade { border-color: var(--success) !important; color: var(--success); box-shadow: 0 0 30px rgba(16, 185, 129, 0.3) !important; }
        .sys-alert { border-color: var(--fail) !important; color: var(--fail); box-shadow: 0 0 30px rgba(239, 68, 68, 0.3) !important; }

        /* --- INPUT STYLING --- */
        #new-agent-name {
            background: rgba(0,0,0,0.3);
            border: 2px solid #334155;
            color: var(--accent);
            padding: 15px;
            font-family: monospace;
            font-weight: 800;
            font-size: 1.2rem;
            width: 100%;
            text-align: center;
            border-radius: 8px;
            text-transform: uppercase;
            margin-bottom: 5px;
            transition: all 0.2s;
            caret-color: var(--gold);
        }
        #new-agent-name:focus {
            border-color: var(--accent);
            box-shadow: 0 0 20px rgba(14, 165, 233, 0.2);
        }
        #new-agent-name::placeholder { color: rgba(255,255,255,0.2); }

    </style>
</head>
<body>

    <div class="header">
        <div class="stat-group">
            <div class="stat" id="btn-user">
                <span class="label">AGENT</span>
                <span id="user-display" class="val">---</span>
                <span id="daily-streak-badge" style="font-size: 0.6rem; color: var(--gold);">üî• 0</span>
            </div>
            <div class="stat" id="btn-analytics">
                <span class="label">Q-XP</span>
                <span id="score-val" class="val xp-val">0</span>
            </div>
            <div class="stat" id="btn-analytics-2">
                <span class="label">LATENCY</span>
                <span id="speed-val" class="val">---ms</span>
            </div>
            <div class="stat" id="btn-leaderboard">
                <span class="label">GRID</span>
                <span id="mode-indicator" class="val">T1</span>
            </div>
        </div>
    </div>
    
    <div id="zone-container">
        <div id="zone-fill"></div>
        <div id="zone-label" data-mult="1.0">NEURAL SYNC: 1.0x</div>
    </div>

    <div id="game-container">
        <canvas id="gameCanvas"></canvas>
        <div id="sync-indicator"></div>

        <div id="system-message" class="hidden">SYSTEM READY</div>

        <div id="main-overlay" class="overlay">
            <h2 id="msg-title">NEURAL READY</h2>
            <p id="msg-body">Initiate flash sequence to begin training.</p>
            <button id="start-btn" class="action-btn">INITIATE FLASH</button>
            <button id="btn-lb-main" class="action-btn secondary-btn" style="margin-top: 10px; font-size: 0.75rem;">üåê GLOBAL GRID</button>
        </div>

        <div id="analytics-overlay" class="overlay hidden">
            <h2>SYSTEM REPORT</h2>
            <canvas id="chart-canvas" style="width: 100%; height: 100px; margin: 10px 0;"></canvas>
            <div class="analytics-grid">
                <div class="a-card"><span class="l">Peak Latency</span><span class="v" id="stat-peak">0ms</span></div>
                <div class="a-card"><span class="l">Accuracy</span><span class="v" id="stat-acc-total">0%</span></div>
                <div class="a-card"><span class="l">Grade</span><span class="v" id="stat-grade" style="color:var(--gold)">--</span></div>
                <div class="a-card"><span class="l">Uptime</span><span class="v" id="stat-uptime">0.0h</span></div>
            </div>
            <button class="action-btn" id="btn-close-analytics">RETURN</button>
        </div>

        <div id="leaderboard-overlay" class="overlay hidden">
            <h2 style="color: var(--gold); letter-spacing: 2px;">GLOBAL GRID</h2>
            <div id="lb-loading" style="font-size: 0.8rem; opacity: 0.6; padding: 20px;">CONNECTING TO CORE...</div>
            <div id="lb-list" style="margin-bottom: 20px;"></div>
            <button class="action-btn" id="btn-close-lb">RETURN</button>
        </div>

        <div id="user-overlay" class="overlay hidden">
            <h3>Select Agent</h3>
            <div id="user-list" style="max-height: 200px; overflow-y: auto;"></div>
            <button class="action-btn" style="background:transparent; border: 1px dashed #444" id="btn-new-user">+ NEW LINK</button>
            <button class="action-btn" style="background:#334155" id="btn-close-user">CANCEL</button>
        </div>

        <div id="new-link-overlay" class="overlay hidden">
            <h3 style="color: var(--accent); letter-spacing: 2px;">NEW CONNECTION</h3>
            <p style="font-size: 0.8rem; opacity: 0.7; margin-bottom: 20px;">ENTER PUBLIC DESIGNATION FOR THE GRID</p>
            
            <input type="text" id="new-agent-name" placeholder="AGENT_ID" maxlength="12" autocomplete="off">
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button id="btn-create-link" class="action-btn">INITIALIZE</button>
                <button id="btn-cancel-link" class="action-btn secondary-btn">ABORT</button>
            </div>
        </div>

    </div>

<script type="module">
    /* ----------------------------------------------------
       NEURAL-SPEED ELITE v3.1 [SECURED CLIENT]
       ----------------------------------------------------
    */

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, doc, setDoc, query, orderBy, limit, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBbUKJ9FgkTMU2WHM4N0uYAujLBDBV-ILs",
      authDomain: "neuro-speed-web.firebaseapp.com",
      projectId: "neuro-speed-web",
      storageBucket: "neuro-speed-web.firebasestorage.app",
      messagingSenderId: "314397349425",
      appId: "1:314397349425:web:992853535b9f8bd61de710"
    };

    (function() {
        // Honeypot
        window.gameScore = 0;
        let honeyPotTriggered = false;
        Object.defineProperty(window, 'gameScore', {
            get: () => 0, set: (val) => { console.warn("Unauthorized memory access detected."); honeyPotTriggered = true; }
        });

        let db;
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            console.log("Neuro-Link Secured.");
        } catch(e) { console.error("Link Error:", e); }

        const SALT = "NEURO_SECURE_SALT_9283"; 
        let appData = { users: {}, currentUser: null };
        let clickHistory = [];
        
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const isTouch = ('ontouchstart' in window || navigator.maxTouchPoints > 0) && window.innerWidth < 1024;

        // Constants
        const SHAPES = ['circle', 'square', 'triangle', 'diamond', 'cross'];
        const L2_COLORS = ['#22d3ee', '#4ade80', '#f472b6', '#fbbf24'];
        
        // Circular Direction Mapping (Standard Canvas 0rad = East)
        const DIR_MAP = [
            { id: 0, key: 6, label: '6', angle: 0 },            // East
            { id: 1, key: 3, label: '3', angle: Math.PI*0.25 },// SE
            { id: 2, key: 2, label: '2', angle: Math.PI*0.5 }, // South
            { id: 3, key: 1, label: '1', angle: Math.PI*0.75 },// SW
            { id: 4, key: 4, label: '4', angle: Math.PI },      // West
            { id: 5, key: 7, label: '7', angle: Math.PI*1.25 },// NW
            { id: 6, key: 8, label: '8', angle: Math.PI*1.5 }, // North
            { id: 7, key: 9, label: '9', angle: Math.PI*1.75 } // NE
        ];

        // Game State
        let state = 'IDLE', currentTask = null, selectionBoxes = [];
        let centerX, centerY, minDim;
        let targetShape, satShape, satColorIdx, satDirIdx;
        let uShape, uSat, uColor, uDir;
        let sessionZone = 0;
        let activeDistractors = [], lastFlashRadius = 0;
        let inputLocked = false, lastSelectionIndex = -1, ripples = [];
        let animFrameId;

        // --- HASHING & SAVE ---
        function generateHash(data) {
            const str = JSON.stringify(data) + SALT;
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return hash.toString();
        }

        function save() {
            if (honeyPotTriggered) return;
            const hash = generateHash(appData);
            localStorage.setItem('neuroElite_v3_secure', JSON.stringify(appData));
            localStorage.setItem('neuroElite_sig', hash);
        }

        function load() {
            const saved = localStorage.getItem('neuroElite_v3_secure');
            const sig = localStorage.getItem('neuroElite_sig');
            if (saved && sig) {
                const check = generateHash(JSON.parse(saved));
                if (check === sig) { appData = JSON.parse(saved); } 
                else { localStorage.clear(); appData = { users: {}, currentUser: null }; }
            }
            if (appData.currentUser) { checkDailyStreak(); updateUI(); } else showUserMenu();
        }

        // --- LOGIC ---
        function checkDailyStreak() {
            const u = appData.users[appData.currentUser];
            const today = new Date().toISOString().split('T')[0];
            if (!u.lastPlayDate) { u.lastPlayDate = today; u.dailyStreak = 1; }
            else if (u.lastPlayDate !== today) {
                const diff = (new Date(today) - new Date(u.lastPlayDate)) / 86400000;
                if (diff >= 0.9 && diff < 2) u.dailyStreak++; else if (diff >= 2) u.dailyStreak = 1;
                u.lastPlayDate = today;
            }
            save();
        }

        function updateUI() {
            const u = appData.users[appData.currentUser];
            if(!u) return;
            document.getElementById('user-display').innerText = appData.currentUser;
            document.getElementById('score-val').innerText = Math.floor(u.score || 0).toLocaleString();
            document.getElementById('speed-val').innerText = Math.round(u.speed) + 'ms';
            document.getElementById('daily-streak-badge').innerText = `üî• ${u.dailyStreak || 0}`;
            document.getElementById('mode-indicator').innerText = u.level3 ? "T3" : (u.level2 ? "T2" : "T1");
            
            const fill = document.getElementById('zone-fill');
            const label = document.getElementById('zone-label');
            const percentage = Math.min(sessionZone * 10, 100);
            fill.style.width = percentage + "%";
            
            if (sessionZone >= 10) {
                fill.style.background = "linear-gradient(90deg, #f59e0b, #ef4444)"; fill.classList.add('zone-gold');
                label.innerText = "SINGULARITY: 5.0x"; canvas.classList.add('singularity-glow');
            } else if (sessionZone >= 5) {
                fill.style.background = "linear-gradient(90deg, #a855f7, #ec4899)"; fill.classList.add('zone-gold');
                label.innerText = "OVERCLOCK: 2.5x"; canvas.classList.remove('singularity-glow');
            } else {
                fill.style.background = "linear-gradient(90deg, var(--accent), #38bdf8)"; fill.classList.remove('zone-gold');
                label.innerText = `ZONE: ${(1.0 + (sessionZone * 0.1)).toFixed(1)}x`; canvas.classList.remove('singularity-glow');
            }
        }

        function drawShape(type, x, y, size, color) {
            ctx.beginPath(); ctx.fillStyle = color;
            if (type === 'circle') ctx.arc(x, y, size, 0, Math.PI * 2);
            else if (type === 'square') ctx.rect(x - size, y - size, size * 2, size * 2);
            else if (type === 'triangle') { ctx.moveTo(x, y - size); ctx.lineTo(x + size, y + size); ctx.lineTo(x - size, y + size); ctx.closePath(); }
            else if (type === 'diamond') { ctx.moveTo(x, y - size * 1.2); ctx.lineTo(x + size * 1.2, y); ctx.lineTo(x, y + size * 1.2); ctx.lineTo(x - size * 1.2, y); ctx.closePath(); }
            else if (type === 'cross') { ctx.rect(x - size/3, y - size, size/1.5, size * 2); ctx.rect(x - size, y - size/3, size * 2, size/1.5); }
            ctx.fill();
        }

        function executeFlash() {
            if (state !== 'IDLE') return;
            state = 'FLASHING';
            const u = appData.users[appData.currentUser];
            
            targetShape = SHAPES[Math.floor(Math.random() * SHAPES.length)];
            satShape = SHAPES[Math.floor(Math.random() * SHAPES.length)];
            satColorIdx = u.level2 ? Math.floor(Math.random() * L2_COLORS.length) : -1;
            satDirIdx = Math.floor(Math.random() * 8); 

            lastFlashRadius = minDim * 0.35;
            // Snaps to grid if L3, otherwise random
            const angle = u.level3 ? DIR_MAP[satDirIdx].angle : Math.random() * Math.PI * 2;
            
            const satX = centerX + Math.cos(angle) * lastFlashRadius; 
            const satY = centerY + Math.sin(angle) * lastFlashRadius;

            activeDistractors = [];
            const count = 12; const step = (Math.PI * 2) / count;
            for (let i = 0; i < count; i++) {
                const a = i * step;
                if (Math.abs(Math.atan2(Math.sin(a - angle), Math.cos(a - angle))) > 0.6) {
                    activeDistractors.push({
                        x: centerX + Math.cos(a) * lastFlashRadius + (Math.random()-0.5)*20,
                        y: centerY + Math.sin(a) * lastFlashRadius + (Math.random()-0.5)*20,
                        shape: SHAPES[Math.floor(Math.random() * SHAPES.length)]
                    });
                }
            }

            let startTime = null;
            function animate(now) {
                if (!startTime) startTime = now;
                const elapsed = now - startTime;
                
                if (elapsed < u.speed) {
                    ctx.clearRect(0,0,canvas.width,canvas.height);
                    activeDistractors.forEach(d => drawShape(d.shape, d.x, d.y, minDim * 0.05, '#334155'));
                    drawShape(targetShape, centerX, centerY, minDim * 0.06, '#fff');
                    drawShape(satShape, satX, satY, minDim * 0.05, u.level2 ? L2_COLORS[satColorIdx] : '#8b5cf6');
                    animFrameId = requestAnimationFrame(animate);
                } else if (elapsed < u.speed + 100) {
                    ctx.fillStyle = "#000"; ctx.fillRect(0,0,canvas.width, canvas.height);
                    animFrameId = requestAnimationFrame(animate);
                } else { 
                    state = 'QUESTIONING'; inputLocked = false; startQuestionLoop(); 
                }
            }
            animFrameId = requestAnimationFrame(animate);
        }

        function startQuestionLoop() {
            askTask('CENTER', SHAPES);
            function loop(now) {
                if (state === 'QUESTIONING') {
                    ctx.fillStyle = '#020617'; ctx.fillRect(0,0,canvas.width,canvas.height);
                    
                    let title = "", sub = "";
                    if(currentTask === 'CENTER') { title = "CORE ID"; sub = "SELECT CENTER SHAPE"; }
                    else if(currentTask === 'SATELLITE') { title = "PERIPHERAL ID"; sub = "SELECT SATELLITE SHAPE"; }
                    else if(currentTask === 'COLOR') { title = "SPECTRUM ID"; sub = "MATCH SATELLITE COLOR"; }
                    else { title = "VECTOR ID"; sub = "INDICATE ORIGIN"; }

                    ctx.textAlign = "center";
                    ctx.fillStyle = "#fff";
                    ctx.font = `900 ${minDim * 0.07}px 'Inter', system-ui`;
                    ctx.fillText(title, centerX, centerY - minDim * 0.15);
                    ctx.fillStyle = "#0ea5e9";
                    ctx.font = `700 ${minDim * 0.03}px monospace`;
                    ctx.fillText(sub, centerX, centerY - minDim * 0.08);

                    selectionBoxes = [];

                    if (currentTask === 'DIRECTION') {
                        // --- CIRCULAR LAYOUT (Compass Rose) ---
                        // "Mirroring actual location"
                        const layoutRadius = minDim * 0.3; // Distance from center
                        const btnSize = minDim * 0.07;

                        DIR_MAP.forEach(dir => {
                            const x = centerX + Math.cos(dir.angle) * layoutRadius;
                            const y = centerY + Math.sin(dir.angle) * layoutRadius;
                            
                            const isSelected = (dir.id === lastSelectionIndex);

                            ctx.beginPath();
                            if (isSelected) {
                                ctx.shadowBlur = 20; ctx.shadowColor = "rgba(14, 165, 233, 0.8)";
                                ctx.fillStyle = "rgba(14, 165, 233, 0.4)";
                            } else {
                                ctx.shadowBlur = 0;
                                ctx.fillStyle = "rgba(255, 255, 255, 0.05)";
                            }
                            ctx.strokeStyle = isSelected ? "var(--accent)" : "#334155";
                            ctx.lineWidth = 3;
                            ctx.arc(x, y, btnSize, 0, Math.PI * 2);
                            ctx.fill(); ctx.stroke();
                            ctx.shadowBlur = 0;

                            // Label (Numpad Number)
                            ctx.fillStyle = isSelected ? "#fff" : "#64748b";
                            ctx.font = `800 ${minDim * 0.05}px monospace`;
                            ctx.textBaseline = "middle";
                            ctx.fillText(dir.label, x, y);
                            ctx.textBaseline = "alphabetic";

                            selectionBoxes.push({ key: dir.key, val: dir.id, x1: x - btnSize, x2: x + btnSize, y1: y - btnSize, y2: y + btnSize, cx: x, cy: y });
                        });

                    } else {
                        // --- STANDARD LINEAR LAYOUT ---
                        const items = currentTask === 'CENTER' ? SHAPES : (currentTask === 'SATELLITE' ? SHAPES : L2_COLORS);       
                        const rowWidth = canvas.width * 0.85; 
                        const spacing = rowWidth / (items.length - 1); 
                        const startX = (canvas.width - rowWidth) / 2;
                        
                        items.forEach((item, i) => {
                            const x = startX + (i * spacing), y = centerY + 60;
                            const isSelected = (i === lastSelectionIndex);
                            if (isSelected) {
                                ctx.save(); ctx.shadowBlur = 20; ctx.shadowColor = "rgba(14, 165, 233, 0.8)";
                                ctx.fillStyle = "rgba(14, 165, 233, 0.2)"; ctx.beginPath(); ctx.arc(x, y, minDim * 0.08, 0, Math.PI*2); ctx.fill(); ctx.restore();
                            }
                            if (currentTask === 'COLOR') { ctx.fillStyle = item; ctx.beginPath(); ctx.arc(x, y, minDim * 0.06, 0, Math.PI*2); ctx.fill(); }
                            else { drawShape(item, x, y, minDim * 0.05, '#fff'); }

                            if (!isTouch) {
                                ctx.fillStyle = isSelected ? "var(--accent)" : "rgba(255, 255, 255, 0.3)";
                                ctx.font = `bold ${minDim * 0.02}px monospace`;
                                ctx.fillText(`[${i + 1}]`, x, y + minDim * 0.15); 
                            }
                            selectionBoxes.push({ key: item, val: i, x1: x - spacing/2, x2: x + spacing/2, y1: y - 100, y2: y + 100, cx: x, cy: y });
                        });
                    }

                    for (let i = ripples.length - 1; i >= 0; i--) {
                        const r = ripples[i]; r.radius += 5; r.opacity -= 0.05;
                        ctx.beginPath(); ctx.arc(r.x, r.y, r.radius, 0, Math.PI * 2);
                        ctx.strokeStyle = `rgba(255, 255, 255, ${r.opacity})`; ctx.stroke();
                        if (r.opacity <= 0) ripples.splice(i, 1);
                    }
                    animFrameId = requestAnimationFrame(loop);
                }
            }
            animFrameId = requestAnimationFrame(loop);
        }

        function askTask(type, items) { currentTask = type; }
        
        function processHit(hit) {
            lastSelectionIndex = hit.val;
            inputLocked = true;
            
            setTimeout(() => { 
                inputLocked = false; lastSelectionIndex = -1;
                const u = appData.users[appData.currentUser];
                
                // SEQUENCE LOGIC: CENTER -> SAT -> COLOR (L2) -> DIRECTION (L3)
                if (currentTask === 'CENTER') { 
                    uShape = hit.key; 
                    askTask('SATELLITE', SHAPES); 
                }
                else if (currentTask === 'SATELLITE') {
                    uSat = hit.key;
                    if (u.level2) askTask('COLOR', L2_COLORS); // Color before Direction
                    else if (u.level3) askTask('DIRECTION', null);
                    else finalizeTrial();
                } 
                else if (currentTask === 'COLOR') { 
                    uColor = hit.val; 
                    if (u.level3) askTask('DIRECTION', null); // Direction Last
                    else finalizeTrial();
                }
                else if (currentTask === 'DIRECTION') { 
                    uDir = hit.val; 
                    finalizeTrial(); 
                }
            }, 320);
        }

        function handleInput(e) {
            if (state !== 'QUESTIONING' || inputLocked) return;
            const rect = canvas.getBoundingClientRect();
            const clientX = e.clientX || (e.touches && e.touches.length > 0 ? e.touches[0].clientX : 0);
            const clientY = e.clientY || (e.touches && e.touches.length > 0 ? e.touches[0].clientY : 0);
            const x = clientX - rect.left;
            const y = clientY - rect.top;
            
            ripples.push({ x: x, y: y, radius: 0, opacity: 1 });
            const hit = selectionBoxes.find(b => x > b.x1 && x < b.x2 && y > b.y1 && y < b.y2);
            if (!hit) return;

            const dist = Math.sqrt(Math.pow(hit.cx - x, 2) + Math.pow(hit.cy - y, 2));
            clickHistory.push(dist);
            if (clickHistory.length > 10) clickHistory.shift();
            const variance = clickHistory.reduce((a, b) => a + b, 0) / clickHistory.length;
            if (clickHistory.length >= 5 && variance < 2.0) { console.warn("Automated input detected."); honeyPotTriggered = true; }

            processHit(hit);
        }

        function triggerSystemMessage(text, type) {
            const el = document.getElementById('system-message');
            el.innerText = text; el.className = ''; 
            if(type === 'upgrade') el.classList.add('sys-upgrade'); else el.classList.add('sys-alert');
            requestAnimationFrame(() => el.classList.remove('hidden'));
            setTimeout(() => el.classList.add('hidden'), 3500);
        }

        function finalizeTrial() {
            if (honeyPotTriggered) { appData.users[appData.currentUser].score = 0; location.reload(); return; }

            const u = appData.users[appData.currentUser];
            let correct = (uShape === targetShape && uSat === satShape);
            if (u.level2 && uColor !== satColorIdx) correct = false;
            if (u.level3 && uDir !== satDirIdx) correct = false;

            state = 'IDLE'; cancelAnimationFrame(animFrameId);
            
            if (correct) {
                sessionZone++;
                let zMult = 1.0 + (sessionZone * 0.1);
                if (sessionZone >= 5) zMult = 2.5;
                if (sessionZone >= 10) zMult = 5.0;

                let baseXP = u.level3 ? 200 : (u.level2 ? 50 : 10);
                let speedEfficiency = Math.pow(450 / u.speed, 2);
                u.score = (u.score || 0) + (baseXP * speedEfficiency * zMult);
                u.streak = Math.max(0, u.streak) + 1;
                
                if (u.streak >= 3) { 
                    u.speed = Math.max(16, u.speed * 0.88); 
                    u.streak = 0; 
                    if (!u.level2 && u.speed <= 350) { u.level2 = true; u.speed = 400; triggerSystemMessage("TIER 2 UNLOCKED", 'upgrade'); }
                    else if (u.level2 && !u.level3 && u.speed <= 220) { u.level3 = true; u.speed = 300; triggerSystemMessage("TIER 3 UNLOCKED", 'upgrade'); }
                }
                document.getElementById('msg-title').innerText = "SYNC SUCCESS";
                document.getElementById('msg-title').style.color = "#10b981";
            } else {
                sessionZone = 0;
                u.streak = Math.min(0, u.streak) - 1;
                u.speed = Math.min(1000, u.speed + 40);
                document.getElementById('msg-title').innerText = "ZONE SHATTERED";
                document.getElementById('msg-title').style.color = "#ef4444";
                if (u.streak <= -3 && (u.level2 || u.level3)) {
                    if (u.level3) { u.level3 = false; triggerSystemMessage("TIER 3 REVOKED", 'alert'); }
                    else { u.level2 = false; triggerSystemMessage("TIER 2 REVOKED", 'alert'); }
                    u.streak = 0; u.speed += 100;
                }
            }
            u.history.push(Math.round(u.speed));
            u.resultsHistory.push({ correct, date: new Date().toISOString().split('T')[0] });
            save(); updateUI();
            
            const startBtn = document.getElementById('start-btn');
            startBtn.classList.add('locked-btn');
            document.getElementById('main-overlay').classList.remove('hidden');
            setTimeout(() => startBtn.classList.remove('locked-btn'), 600);
            
            backgroundSync();
        }

        function backgroundSync() {
            if (!appData.currentUser || honeyPotTriggered || appData.users[appData.currentUser].speed < 100) return;
            const u = appData.users[appData.currentUser];
            const ind = document.getElementById('sync-indicator'); ind.classList.add('syncing');

            const total = u.resultsHistory.length;
            const correct = u.resultsHistory.filter(r => r.correct).length;
            const accuracy = total > 0 ? Math.round((correct / total) * 100) : 0;

            setDoc(doc(db, "leaderboard", appData.currentUser), {
                name: appData.currentUser, score: Math.floor(u.score), speed: Math.min(...u.history),
                accuracy: accuracy, tier: u.level3 ? "T3" : (u.level2 ? "T2" : "T1"), timestamp: new Date()
            }, { merge: true }).then(() => setTimeout(() => ind.classList.remove('syncing'), 500))
            .catch((e) => { console.log("Bg Sync Fail", e); ind.classList.remove('syncing'); });
        }

        // --- HANDLERS ---
        function hideOverlays() { document.querySelectorAll('.overlay').forEach(o => o.classList.add('hidden')); }
        
        document.getElementById('start-btn').onclick = () => { hideOverlays(); setTimeout(executeFlash, 300); };
        document.getElementById('btn-user').onclick = showUserMenu;
        document.getElementById('btn-analytics').onclick = showAnalytics;
        document.getElementById('btn-analytics-2').onclick = showAnalytics;
        document.getElementById('btn-leaderboard').onclick = showLeaderboard;
        document.getElementById('btn-lb-main').onclick = showLeaderboard;
        document.getElementById('btn-close-analytics').onclick = () => { hideOverlays(); document.getElementById('main-overlay').classList.remove('hidden'); };
        document.getElementById('btn-close-lb').onclick = () => { hideOverlays(); document.getElementById('main-overlay').classList.remove('hidden'); };
        document.getElementById('btn-close-user').onclick = () => { if(appData.currentUser) { hideOverlays(); document.getElementById('main-overlay').classList.remove('hidden'); } };
        
        // --- NEW LINK HANDLERS ---
        
        // Open the New Link Overlay
        document.getElementById('btn-new-user').onclick = () => {
             hideOverlays(); 
             const overlay = document.getElementById('new-link-overlay');
             const input = document.getElementById('new-agent-name');
             overlay.classList.remove('hidden');
             input.value = '';
             setTimeout(() => input.focus(), 100);
        };

        // Initialize User Creation Logic
        function createNewUser() {
            const input = document.getElementById('new-agent-name');
            const n = input.value.trim().toUpperCase();
            
            if (n && n.length > 0) {
                if (appData.users[n]) {
                    alert("DESIGNATION ALREADY TAKEN.");
                    return;
                }
                appData.users[n] = { speed: 450, score: 0, streak: 0, history: [450], resultsHistory: [], level2: false, level3: false, totalTimeMs: 0, dailyStreak: 0, lastPlayDate: null };
                appData.currentUser = n; sessionZone = 0; save(); updateUI(); hideOverlays(); 
                document.getElementById('main-overlay').classList.remove('hidden');
            }
        }

        document.getElementById('btn-create-link').onclick = createNewUser;
        
        // Handle Enter Key in Input
        document.getElementById('new-agent-name').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') createNewUser();
        });

        document.getElementById('btn-cancel-link').onclick = () => {
             hideOverlays();
             if (appData.currentUser) {
                 document.getElementById('main-overlay').classList.remove('hidden');
             } else {
                 showUserMenu();
             }
        };

        async function showLeaderboard() {
            hideOverlays(); document.getElementById('leaderboard-overlay').classList.remove('hidden');
            const list = document.getElementById('lb-list'); list.innerHTML = "";
            document.getElementById('lb-loading').style.display = 'block';
            try {
                const q = query(collection(db, "leaderboard"), orderBy("score", "desc"), limit(20));
                const querySnapshot = await getDocs(q);
                document.getElementById('lb-loading').style.display = 'none';
                let rank = 1;
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    const acc = data.accuracy !== undefined ? data.accuracy + "%" : "--";
                    const row = document.createElement('div'); row.className = 'lb-row';
                    row.innerHTML = `<div class="lb-rank">${rank++}</div><div class="lb-name"><span class="lb-tier">${data.tier}</span>${data.name}</div><div class="lb-right"><span class="lb-score">${data.score.toLocaleString()}</span><div class="lb-sub"><span class="lb-stat peak">‚ö°${data.speed}ms</span><span class="lb-stat acc">üéØ${acc}</span></div></div>`;
                    list.appendChild(row);
                });
                if (querySnapshot.empty) list.innerHTML = "<div style='opacity:0.5; margin-top:20px'>NO DATA ON THE GRID</div>";
            } catch (e) { document.getElementById('lb-loading').innerText = "CONNECTION FAILURE"; }
        }

        function showAnalytics() {
            hideOverlays(); document.getElementById('analytics-overlay').classList.remove('hidden');
            const u = appData.users[appData.currentUser];
            const cv = document.getElementById('chart-canvas'), cx = cv.getContext('2d');
            cv.width = cv.offsetWidth * 2; cv.height = cv.offsetHeight * 2;
            cx.strokeStyle = "#0ea5e9"; cx.lineWidth = 4; cx.beginPath();
            const data = u.history.slice(-30);
            data.forEach((v, i) => {
                const x = (i / (data.length - 1 || 1)) * cv.width;
                const y = cv.height - (v / 1000 * cv.height);
                if (i === 0) cx.moveTo(x,y); else cx.lineTo(x,y);
            });
            cx.stroke();
            const acc = Math.round((u.resultsHistory.filter(r => r.correct).length / u.resultsHistory.length * 100)) || 0;
            document.getElementById('stat-peak').innerText = `${Math.min(...u.history)}ms`;
            document.getElementById('stat-acc-total').innerText = `${acc}%`;
            document.getElementById('stat-uptime').innerText = (u.totalTimeMs / 3600000).toFixed(1) + 'h';
            document.getElementById('stat-grade').innerText = acc > 90 ? "S" : (acc > 75 ? "A" : "B");
        }

        function showUserMenu() {
            hideOverlays(); document.getElementById('user-overlay').classList.remove('hidden');
            const list = document.getElementById('user-list'); list.innerHTML = '';
            Object.keys(appData.users).forEach(name => {
                const btn = document.createElement('div'); btn.className = 'a-card';
                btn.style.marginBottom = '8px'; btn.style.cursor = 'pointer';
                btn.innerHTML = `<span class="l">${name}</span><span class="v">${Math.round(appData.users[name].speed)}ms</span>`;
                btn.onclick = () => { appData.currentUser = name; sessionZone = 0; checkDailyStreak(); updateUI(); hideOverlays(); document.getElementById('main-overlay').classList.remove('hidden'); };
                list.appendChild(btn);
            });
        }

        function resize() { 
            canvas.width = window.innerWidth; canvas.height = window.innerHeight - 96; 
            centerX = canvas.width / 2; centerY = canvas.height / 2; 
            minDim = Math.min(canvas.width, canvas.height); 
        }

        window.addEventListener('resize', resize);
        canvas.addEventListener('mousedown', handleInput);
        canvas.addEventListener('touchstart', (e) => { e.preventDefault(); handleInput(e); }, {passive: false});
        
        window.addEventListener('keydown', (e) => {
            if (state !== 'QUESTIONING' || inputLocked) return;
            
            // Directional Input (Numpad)
            if (currentTask === 'DIRECTION') {
                 const keyVal = parseInt(e.key);
                 if (!isNaN(keyVal)) {
                     const hit = selectionBoxes.find(b => b.key === keyVal);
                     if (hit) {
                        ripples.push({ x: hit.cx, y: hit.cy, radius: 0, opacity: 1 });
                        processHit(hit);
                        return;
                     }
                 }
            }
            
            // Standard Linear Input (1-5)
            const index = parseInt(e.key) - 1;
            if (index >= 0 && index < selectionBoxes.length && currentTask !== 'DIRECTION') {
                const hit = selectionBoxes[index];
                ripples.push({ x: hit.cx, y: hit.cy, radius: 0, opacity: 1 });
                processHit(hit);
            }
        });

        resize(); load();
        setInterval(() => { if (appData.currentUser) appData.users[appData.currentUser].totalTimeMs += 2000; }, 2000);

    })();
</script>
</body>
</html>
