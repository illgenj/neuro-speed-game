<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Neuro-Speed Elite 20.0 + HAPTIC VISUALS</title>
    <style>
        :root { 
            --bg: #020617; --panel: #0f172a; --accent: #0ea5e9; --text: #f8fafc; 
            --success: #10b981; --fail: #ef4444; --gold: #f59e0b; --quantum: #a855f7; 
            --hyper: #f43f5e; --glass: rgba(15, 23, 42, 0.96);
        }
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        
        body { 
            background: var(--bg); color: var(--text); 
            font-family: 'Inter', system-ui, -apple-system, sans-serif; 
            margin: 0; display: flex; flex-direction: column; 
            height: 100vh; overflow: hidden; touch-action: none; 
        }

        /* --- Header & Interactive Stats --- */
        .header { 
            height: 90px; width: 100%; display: flex; align-items: center; 
            background: var(--panel); border-bottom: 2px solid #1e293b; 
            z-index: 50; flex-shrink: 0;
        }
        .stat-group { display: flex; flex-grow: 1; justify-content: space-around; height: 100%; }
        
        .stat { 
            text-align: center; display: flex; flex-direction: column; 
            justify-content: center; padding: 0 5px; cursor: pointer; 
            transition: all 0.2s; min-width: 60px;
        }
        
        .label { font-size: 0.5rem; text-transform: uppercase; opacity: 0.4; letter-spacing: 1.2px; margin-bottom: 2px; font-weight: 700; }
        .val { font-size: 0.85rem; font-weight: 800; color: var(--accent); font-family: monospace; }
        .xp-val { color: var(--gold); }

        /* --- Zone Meter --- */
        #zone-container {
            width: 100%; height: 6px; background: #1e293b; position: relative; overflow: hidden;
        }
        #zone-fill {
            height: 100%; width: 0%; background: var(--accent);
            transition: width 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275), background 0.5s;
            box-shadow: 0 0 15px var(--accent);
        }
        #zone-label {
            position: absolute; top: 10px; right: 20px; font-size: 0.6rem; 
            font-weight: 900; color: var(--accent); letter-spacing: 2px;
        }

        /* --- Game Area --- */
        #game-container { flex-grow: 1; position: relative; width: 100%; overflow: hidden; }
        canvas { display: block; width: 100%; height: 100%; transition: filter 0.3s; }

        /* --- UI Overlays --- */
        .overlay { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            background: var(--glass); backdrop-filter: blur(20px); padding: 30px; 
            border-radius: 24px; text-align: center; border: 1px solid rgba(255,255,255,0.1); 
            width: 90%; max-width: 400px; z-index: 100; 
            box-shadow: 0 40px 80px -20px rgba(0, 0, 0, 0.9);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            max-height: 80vh; overflow-y: auto;
        }
        .hidden { opacity: 0; pointer-events: none; transform: translate(-50%, -45%) scale(0.95); }
        
        .action-btn { 
            background: var(--accent); color: white; border: none; padding: 18px; 
            font-size: 0.9rem; font-weight: 800; border-radius: 14px; cursor: pointer; 
            width: 100%; margin-top: 10px; transition: all 0.2s;
            text-transform: uppercase; letter-spacing: 1px;
        }
        .action-btn:active { transform: scale(0.97); }
        .secondary-btn { background: #334155; }

        .analytics-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin: 15px 0; }
        .a-card { background: rgba(0,0,0,0.4); padding: 12px; border-radius: 16px; text-align: left; }
        .a-card .v { display: block; font-weight: 800; color: var(--accent); font-size: 1rem; }
        .a-card .l { font-size: 0.5rem; opacity: 0.4; text-transform: uppercase; font-weight: 700; }

        /* Leaderboard Specifics */
        .lb-row { display: flex; align-items: center; padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 0.9rem; }
        .lb-rank { width: 30px; color: var(--gold); font-weight: 900; }
        .lb-name { flex-grow: 1; text-align: left; font-weight: 600; }
        .lb-score { color: var(--accent); font-family: monospace; font-weight: 700; }
        .lb-tier { font-size: 0.6rem; background: #1e293b; padding: 2px 6px; border-radius: 4px; margin-right: 8px; color: #94a3b8; }
        
        /* Auto-save indicator */
        #sync-indicator {
            position: absolute; top: 15px; left: 15px; width: 8px; height: 8px; 
            background: var(--success); border-radius: 50%; opacity: 0; transition: opacity 0.5s;
            box-shadow: 0 0 10px var(--success); pointer-events: none;
        }
        .syncing { opacity: 1 !important; }

        /* Effects */
        .singularity-glow { filter: saturate(1.5) contrast(1.1); }
    </style>
</head>
<body>

    <div class="header">
        <div class="stat-group">
            <div class="stat" onclick="showUserMenu()">
                <span class="label">AGENT</span>
                <span id="user-display" class="val">---</span>
                <span id="daily-streak-badge" style="font-size: 0.6rem; color: var(--gold);">üî• 0</span>
            </div>
            <div class="stat" onclick="showAnalytics()">
                <span class="label">Q-XP</span>
                <span id="score-val" class="val xp-val">0</span>
            </div>
            <div class="stat" onclick="showAnalytics()">
                <span class="label">LATENCY</span>
                <span id="speed-val" class="val">---ms</span>
            </div>
            <div class="stat" onclick="showLeaderboard()">
                <span class="label">GRID</span>
                <span id="mode-indicator" class="val">T1</span>
            </div>
        </div>
    </div>
    
    <div id="zone-container">
        <div id="zone-fill"></div>
        <div id="zone-label">NEURAL SYNC: 1.0x</div>
    </div>

    <div id="game-container">
        <canvas id="gameCanvas"></canvas>
        <div id="sync-indicator"></div>

        <div id="main-overlay" class="overlay">
            <h2 id="msg-title">NEURAL READY</h2>
            <p id="msg-body">Initiate flash sequence to begin training.</p>
            <button id="start-btn" class="action-btn">INITIATE FLASH</button>
            <button onclick="showLeaderboard()" class="action-btn secondary-btn" style="margin-top: 10px; font-size: 0.75rem;">üåê GLOBAL GRID</button>
        </div>

        <div id="analytics-overlay" class="overlay hidden">
            <h2>SYSTEM REPORT</h2>
            <canvas id="chart-canvas" style="width: 100%; height: 100px; margin: 10px 0;"></canvas>
            <div class="analytics-grid">
                <div class="a-card"><span class="l">Peak Latency</span><span class="v" id="stat-peak">0ms</span></div>
                <div class="a-card"><span class="l">Accuracy</span><span class="v" id="stat-acc-total">0%</span></div>
                <div class="a-card"><span class="l">Grade</span><span class="v" id="stat-grade" style="color:var(--gold)">--</span></div>
                <div class="a-card"><span class="l">Uptime</span><span class="v" id="stat-uptime">0.0h</span></div>
            </div>
            <button class="action-btn" onclick="closeAnalytics()">RETURN</button>
        </div>

        <div id="leaderboard-overlay" class="overlay hidden">
            <h2 style="color: var(--gold); letter-spacing: 2px;">GLOBAL GRID</h2>
            <div id="lb-loading" style="font-size: 0.8rem; opacity: 0.6; padding: 20px;">CONNECTING TO CORE...</div>
            <div id="lb-list" style="margin-bottom: 20px;"></div>
            <button class="action-btn" onclick="closeLeaderboard()">RETURN</button>
        </div>

        <div id="user-overlay" class="overlay hidden">
            <h3>Select Agent</h3>
            <div id="user-list" style="max-height: 200px; overflow-y: auto;"></div>
            <button class="action-btn" style="background:transparent; border: 1px dashed #444" onclick="createNewUser()">+ NEW LINK</button>
            <button class="action-btn" style="background:#334155" onclick="closeUserMenu()">CANCEL</button>
        </div>
    </div>

<script type="module">
    // --- FIREBASE SETUP ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, doc, setDoc, query, orderBy, limit, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBbUKJ9FgkTMU2WHM4N0uYAujLBDBV-ILs",
      authDomain: "neuro-speed-web.firebaseapp.com",
      projectId: "neuro-speed-web",
      storageBucket: "neuro-speed-web.firebasestorage.app",
      messagingSenderId: "314397349425",
      appId: "1:314397349425:web:992853535b9f8bd61de710"
    };

    let db;
    try {
        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        console.log("Neuro-Link Established");
    } catch(e) {
        console.error("Firebase Init Error:", e);
    }

    // --- GAME LOGIC ---
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    let appData = { users: {}, currentUser: null };
    
    const SHAPES = ['circle', 'square', 'triangle', 'diamond', 'cross'];
    const L2_COLORS = ['#22d3ee', '#4ade80', '#f472b6', '#fbbf24'];
    const DIRECTIONS = ['NW', 'NE', 'SW', 'SE'];
    
    let state = 'IDLE', currentTask = null, selectionBoxes = [];
    let centerX, centerY, minDim;
    let targetShape, satShape, satColorIdx, satDirIdx;
    let uShape, uSat, uColor, uDir;
    let sessionZone = 0;
    
    // --- VISUAL FX SYSTEM ---
    let ripples = []; // Array to store active ripples

    function save() { localStorage.setItem('neuroElite_v18', JSON.stringify(appData)); }
    function load() {
        const saved = localStorage.getItem('neuroElite_v18');
        if (saved) appData = JSON.parse(saved);
        if (appData.currentUser) { checkDailyStreak(); updateUI(); } else showUserMenu();
    }

    function checkDailyStreak() {
        const u = appData.users[appData.currentUser];
        const today = new Date().toISOString().split('T')[0];
        if (!u.lastPlayDate) { u.lastPlayDate = today; u.dailyStreak = 1; }
        else if (u.lastPlayDate !== today) {
            const diff = (new Date(today) - new Date(u.lastPlayDate)) / 86400000;
            if (diff === 1) u.dailyStreak++; else if (diff > 1) u.dailyStreak = 1;
            u.lastPlayDate = today;
        }
        save();
    }

    function updateUI() {
        const u = appData.users[appData.currentUser];
        if(!u) return;
        document.getElementById('user-display').innerText = appData.currentUser;
        document.getElementById('score-val').innerText = Math.floor(u.score || 0).toLocaleString();
        document.getElementById('speed-val').innerText = Math.round(u.speed) + 'ms';
        document.getElementById('daily-streak-badge').innerText = `üî• ${u.dailyStreak || 0}`;
        document.getElementById('mode-indicator').innerText = u.level3 ? "T3" : (u.level2 ? "T2" : "T1");
        
        // Zone Meter Update
        const fill = document.getElementById('zone-fill');
        const label = document.getElementById('zone-label');
        const percentage = Math.min(sessionZone * 10, 100);
        fill.style.width = percentage + "%";
        
        let mult = 1.0;
        if (sessionZone >= 10) {
            mult = 5.0; fill.style.background = "var(--gold)"; label.style.color = "var(--gold)";
            label.innerText = "SINGULARITY: 5.0x";
            canvas.classList.add('singularity-glow');
        } else if (sessionZone >= 5) {
            mult = 2.5; fill.style.background = "var(--quantum)"; label.style.color = "var(--quantum)";
            label.innerText = "OVERCLOCK: 2.5x";
            canvas.classList.remove('singularity-glow');
        } else {
            mult = 1.0 + (sessionZone * 0.1);
            fill.style.background = "var(--accent)"; label.style.color = "var(--accent)";
            label.innerText = `ZONE: ${mult.toFixed(1)}x`;
            canvas.classList.remove('singularity-glow');
        }
    }

    function drawShape(type, x, y, size, color) {
        ctx.beginPath(); ctx.fillStyle = color;
        if (type === 'circle') ctx.arc(x, y, size, 0, Math.PI * 2);
        else if (type === 'square') ctx.rect(x - size, y - size, size * 2, size * 2);
        else if (type === 'triangle') { ctx.moveTo(x, y - size); ctx.lineTo(x + size, y + size); ctx.lineTo(x - size, y + size); ctx.closePath(); }
        else if (type === 'diamond') { ctx.moveTo(x, y - size * 1.2); ctx.lineTo(x + size * 1.2, y); ctx.lineTo(x, y + size * 1.2); ctx.lineTo(x - size * 1.2, y); ctx.closePath(); }
        else if (type === 'cross') { ctx.rect(x - size/3, y - size, size/1.5, size * 2); ctx.rect(x - size, y - size/3, size * 2, size/1.5); }
        ctx.fill();
    }

    function executeFlash() {
        if (state !== 'IDLE') return;
        state = 'FLASHING';
        const u = appData.users[appData.currentUser];
        targetShape = SHAPES[Math.floor(Math.random() * SHAPES.length)];
        satShape = SHAPES[Math.floor(Math.random() * SHAPES.length)];
        satColorIdx = u.level2 ? Math.floor(Math.random() * L2_COLORS.length) : -1;
        satDirIdx = Math.floor(Math.random() * 4);

        const radius = minDim * 0.35;
        const angle = u.level3 ? [Math.PI*1.25, Math.PI*1.75, Math.PI*0.75, Math.PI*0.25][satDirIdx] : Math.random() * Math.PI * 2;
        const satX = centerX + Math.cos(angle) * radius, satY = centerY + Math.sin(angle) * radius;

        const startTime = performance.now();
        function animate(now) {
            const elapsed = now - startTime;
            if (elapsed < u.speed) {
                ctx.clearRect(0,0,canvas.width,canvas.height);
                drawShape(targetShape, centerX, centerY, minDim * 0.06, '#fff');
                drawShape(satShape, satX, satY, minDim * 0.05, u.level2 ? L2_COLORS[satColorIdx] : '#8b5cf6');
                requestAnimationFrame(animate);
            } else if (elapsed < u.speed + 80) {
                ctx.fillStyle = "#000"; ctx.fillRect(0,0,canvas.width, canvas.height);
                for(let i=0; i<100; i++) { ctx.fillStyle = Math.random() > 0.5 ? "#fff" : "#111"; ctx.fillRect(Math.random()*canvas.width, Math.random()*canvas.height, 20, 20); }
                requestAnimationFrame(animate);
            } else { state = 'QUESTIONING'; startQuestionLoop(); }
        }
        requestAnimationFrame(animate);
    }

    // --- NEW QUESTION LOOP (Supports Animation) ---
    function startQuestionLoop() {
        askTask('CENTER', SHAPES);
        function loop() {
            if (state === 'QUESTIONING') {
                // Redraw background/UI
                ctx.fillStyle = '#020617'; ctx.fillRect(0,0,canvas.width,canvas.height);
                
                // Draw Question
                ctx.fillStyle = "#fff"; ctx.textAlign = "center"; ctx.font = `900 ${minDim * 0.05}px sans-serif`;
                ctx.fillText(`${currentTask} IDENT`, centerX, centerY - minDim * 0.25);
                
                // Draw Selection Items
                const items = currentTask === 'CENTER' ? SHAPES : 
                              (currentTask === 'SATELLITE' ? SHAPES : 
                              (currentTask === 'COLOR' ? L2_COLORS : DIRECTIONS));
                              
                const rowWidth = canvas.width * 0.85, spacing = rowWidth / (items.length - 1), startX = (canvas.width - rowWidth) / 2;
                
                // We update box positions here just in case, though they are static per task
                selectionBoxes = [];
                items.forEach((item, i) => {
                    const x = startX + (i * spacing), y = centerY + 40;
                    if (currentTask === 'COLOR') { ctx.fillStyle = item; ctx.beginPath(); ctx.arc(x, y, minDim * 0.06, 0, Math.PI*2); ctx.fill(); }
                    else if (currentTask === 'DIRECTION') { ctx.fillStyle = "#fff"; ctx.font = `bold ${minDim * 0.04}px monospace`; ctx.fillText(item, x, y + 10); }
                    else { drawShape(item, x, y, minDim * 0.05, '#fff'); }
                    selectionBoxes.push({ key: item, val: i, x1: x - spacing/2, x2: x + spacing/2, y1: y - 100, y2: y + 100 });
                });

                // Draw Ripples
                drawRipples();
                
                requestAnimationFrame(loop);
            }
        }
        loop();
    }

    function askTask(type, items) {
        currentTask = type; 
        // selectionBoxes calculation moved to loop for consistency, but logic remains same
    }
    
    // --- RIPPLE EFFECT LOGIC ---
    function spawnRipple(x, y, color) {
        ripples.push({ x: x, y: y, radius: 0, opacity: 1, color: color });
    }
    
    function drawRipples() {
        for (let i = ripples.length - 1; i >= 0; i--) {
            const r = ripples[i];
            r.radius += 5; // Expand speed
            r.opacity -= 0.05; // Fade speed
            
            ctx.beginPath();
            ctx.arc(r.x, r.y, r.radius, 0, Math.PI * 2);
            ctx.strokeStyle = `rgba(255, 255, 255, ${r.opacity})`; // White ripple
            if(r.color) ctx.fillStyle = r.color; // Optional colored fill
            ctx.lineWidth = 2;
            ctx.stroke();
            
            if (r.opacity <= 0) ripples.splice(i, 1);
        }
    }

    function handleInput(e) {
        if (state !== 'QUESTIONING') return;
        const rect = canvas.getBoundingClientRect();
        const x = (e.clientX || (e.touches && e.touches[0].clientX)) - rect.left;
        const y = (e.clientY || (e.touches && e.touches[0].clientY)) - rect.top;
        
        // Spawn Visual Ripple immediately on click/touch
        spawnRipple(x, y);

        const hit = selectionBoxes.find(b => x > b.x1 && x < b.x2 && y > b.y1 && y < b.y2);
        if (!hit) return;
        
        const u = appData.users[appData.currentUser];
        if (currentTask === 'CENTER') { uShape = hit.key; askTask('SATELLITE', SHAPES); }
        else if (currentTask === 'SATELLITE') {
            uSat = hit.key;
            if (u.level3) askTask('DIRECTION', DIRECTIONS);
            else if (u.level2) askTask('COLOR', L2_COLORS);
            else finalizeTrial();
        } else if (currentTask === 'COLOR') { uColor = hit.val; finalizeTrial(); }
        else if (currentTask === 'DIRECTION') { uDir = hit.val; if (u.level2) askTask('COLOR', L2_COLORS); else finalizeTrial(); }
    }

    function finalizeTrial() {
        const u = appData.users[appData.currentUser];
        let correct = (uShape === targetShape && uSat === satShape);
        if (u.level2 && uColor !== satColorIdx) correct = false;
        if (u.level3 && uDir !== satDirIdx) correct = false;

        state = 'IDLE';
        if (correct) {
            sessionZone++;
            // Calculate Multiplier
            let zMult = 1.0 + (sessionZone * 0.1);
            if (sessionZone >= 5) zMult = 2.5;
            if (sessionZone >= 10) zMult = 5.0;

            let baseXP = u.level3 ? 200 : (u.level2 ? 50 : 10);
            let speedEfficiency = Math.pow(450 / u.speed, 2);
            u.score = (u.score || 0) + (baseXP * speedEfficiency * zMult);
            
            u.streak = Math.max(0, u.streak) + 1;
            if (u.streak >= 3) { u.speed = Math.max(16, u.speed * 0.88); u.streak = 0; }
            document.getElementById('msg-title').innerText = "SYNC SUCCESS";
            document.getElementById('msg-title').style.color = "#10b981";
        } else {
            sessionZone = 0; // SHATTER ZONE
            u.streak = Math.min(0, u.streak) - 1;
            u.speed = Math.min(1000, u.speed + 40);
            document.getElementById('msg-title').innerText = "ZONE SHATTERED";
            document.getElementById('msg-title').style.color = "#ef4444";
            if (u.streak <= -3 && (u.level2 || u.level3)) {
                if (u.level3) u.level3 = false; else u.level2 = false;
                u.streak = 0; u.speed += 100;
            }
        }
        u.history.push(Math.round(u.speed));
        u.resultsHistory.push({ correct, date: new Date().toISOString().split('T')[0] });
        save(); updateUI();
        document.getElementById('main-overlay').classList.remove('hidden');
        
        // --- AUTO UPLOAD TRIGGER ---
        backgroundSync();
    }

    function backgroundSync() {
        if (!appData.currentUser) return;
        
        // Use requestIdleCallback if available to ensure zero lag, otherwise setTimeout
        const sync = () => {
            const u = appData.users[appData.currentUser];
            const ind = document.getElementById('sync-indicator');
            ind.classList.add('syncing');

            // SetDoc with {merge:true} updates the existing entry instead of creating a new one
            setDoc(doc(db, "leaderboard", appData.currentUser), {
                name: appData.currentUser,
                score: Math.floor(u.score),
                speed: Math.min(...u.history),
                tier: u.level3 ? "T3" : (u.level2 ? "T2" : "T1"),
                timestamp: new Date()
            }, { merge: true })
            .then(() => {
                setTimeout(() => ind.classList.remove('syncing'), 500);
            })
            .catch((e) => {
                console.log("Bg Sync Fail (harmless)", e);
                ind.classList.remove('syncing');
            });
        };

        if (window.requestIdleCallback) {
            window.requestIdleCallback(sync);
        } else {
            setTimeout(sync, 0);
        }
    }

    function shareResults() {
        const u = appData.users[appData.currentUser];
        const report = `üß† NEURAL REPORT\nüèÜ Q-XP: ${Math.floor(u.score).toLocaleString()}\n‚ö° Peak: ${Math.min(...u.history)}ms\nüî• Days: ${u.dailyStreak}\n\nLink up and compete.`;
        if (navigator.share) navigator.share({ text: report });
        else { navigator.clipboard.writeText(report); alert("Data copied."); }
    }

    // --- LEADERBOARD LOGIC ---
    window.uploadScore = function() { backgroundSync(); }

    window.showLeaderboard = async function() {
        hideOverlays();
        document.getElementById('leaderboard-overlay').classList.remove('hidden');
        const list = document.getElementById('lb-list');
        list.innerHTML = "";
        document.getElementById('lb-loading').style.display = 'block';

        try {
            const q = query(collection(db, "leaderboard"), orderBy("score", "desc"), limit(20));
            const querySnapshot = await getDocs(q);
            
            document.getElementById('lb-loading').style.display = 'none';
            
            let rank = 1;
            querySnapshot.forEach((doc) => {
                const data = doc.data();
                const row = document.createElement('div');
                row.className = 'lb-row';
                row.innerHTML = `
                    <div class="lb-rank">${rank++}</div>
                    <div class="lb-name">
                        <span class="lb-tier">${data.tier}</span>
                        ${data.name}
                    </div>
                    <div class="lb-score">${data.score.toLocaleString()}</div>
                `;
                list.appendChild(row);
            });

            if (querySnapshot.empty) {
                list.innerHTML = "<div style='opacity:0.5; margin-top:20px'>NO DATA ON THE GRID</div>";
            }

        } catch (e) {
            console.error(e);
            document.getElementById('lb-loading').innerText = "CONNECTION FAILURE";
        }
    }

    window.closeLeaderboard = function() {
        hideOverlays();
        document.getElementById('main-overlay').classList.remove('hidden');
    }

    // --- EXISTING UI LOGIC ---
    window.showAnalytics = function() {
        hideOverlays(); document.getElementById('analytics-overlay').classList.remove('hidden');
        const u = appData.users[appData.currentUser];
        const cv = document.getElementById('chart-canvas'), cx = cv.getContext('2d');
        cv.width = cv.offsetWidth * 2; cv.height = cv.offsetHeight * 2;
        cx.strokeStyle = "#0ea5e9"; cx.lineWidth = 4; cx.beginPath();
        const data = u.history.slice(-30);
        data.forEach((v, i) => {
            const x = (i / (data.length - 1 || 1)) * cv.width;
            const y = cv.height - (v / 1000 * cv.height);
            if (i === 0) cx.moveTo(x,y); else cx.lineTo(x,y);
        });
        cx.stroke();
        const acc = Math.round((u.resultsHistory.filter(r => r.correct).length / u.resultsHistory.length * 100)) || 0;
        document.getElementById('stat-peak').innerText = `${Math.min(...u.history)}ms`;
        document.getElementById('stat-acc-total').innerText = `${acc}%`;
        document.getElementById('stat-uptime').innerText = (u.totalTimeMs / 3600000).toFixed(1) + 'h';
        document.getElementById('stat-grade').innerText = acc > 90 ? "S" : (acc > 75 ? "A" : "B");
    }

    window.showUserMenu = function() {
        hideOverlays(); document.getElementById('user-overlay').classList.remove('hidden');
        const list = document.getElementById('user-list'); list.innerHTML = '';
        Object.keys(appData.users).forEach(name => {
            const btn = document.createElement('div'); btn.className = 'a-card';
            btn.style.marginBottom = '8px'; btn.style.cursor = 'pointer';
            btn.innerHTML = `<span class="l">${name}</span><span class="v">${Math.round(appData.users[name].speed)}ms</span>`;
            btn.onclick = () => { appData.currentUser = name; sessionZone = 0; checkDailyStreak(); updateUI(); hideOverlays(); document.getElementById('main-overlay').classList.remove('hidden'); };
            list.appendChild(btn);
        });
    }

    window.createNewUser = function() {
        const n = prompt("Agent ID:");
        if (n && n.trim()) {
            appData.users[n] = { speed: 450, score: 0, streak: 0, history: [450], resultsHistory: [], level2: false, level3: false, totalTimeMs: 0, dailyStreak: 0, lastPlayDate: null };
            appData.currentUser = n; sessionZone = 0; save(); updateUI(); hideOverlays(); document.getElementById('main-overlay').classList.remove('hidden');
        }
    }

    // Attach other global helpers
    window.shareResults = shareResults;
    window.closeAnalytics = closeAnalytics;
    window.closeUserMenu = closeUserMenu;

    function hideOverlays() { document.querySelectorAll('.overlay').forEach(o => o.classList.add('hidden')); }
    function closeAnalytics() { hideOverlays(); document.getElementById('main-overlay').classList.remove('hidden'); }
    function closeUserMenu() { if(appData.currentUser) hideOverlays(), document.getElementById('main-overlay').classList.remove('hidden'); }
    function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight - 96; centerX = canvas.width / 2; centerY = canvas.height / 2; minDim = Math.min(canvas.width, canvas.height); }

    window.addEventListener('resize', resize);
    canvas.addEventListener('mousedown', handleInput);
    canvas.addEventListener('touchstart', (e) => { e.preventDefault(); handleInput(e); }, {passive: false});
    document.getElementById('start-btn').addEventListener('click', () => { hideOverlays(); setTimeout(executeFlash, 300); });

    setInterval(() => { if (appData.currentUser) appData.users[appData.currentUser].totalTimeMs += 2000; }, 2000);
    resize(); load();
</script>
</body>
</html>